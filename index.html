<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG (Management Game) - Ultimate Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f0f2f5; min-height: 100vh; color: #1a1a1a; }
        .container { max-width: 1600px; margin: 0 auto; padding: 10px; }
        
        /* ヘッダー */
        .header { background: white; border-radius: 8px; padding: 15px 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .period-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .info-item { background: #f8f9fa; padding: 8px 12px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .info-item:hover { background: #e9ecef; }
        .info-label { font-size: 12px; color: #666; font-weight: normal; }
        .info-value { font-size: 16px; font-weight: bold; color: #2c3e50; }
        
        /* メインレイアウト */
        .main-layout { display: grid; grid-template-columns: 400px 1fr; gap: 15px; }
        
        /* 市場セクション */
        .markets-section { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e9ecef; color: #2c3e50; }
        .market-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; margin-bottom: 8px; }
        .market-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .market-name { font-weight: bold; font-size: 14px; color: #495057; }
        .market-prices { display: flex; gap: 8px; }
        .price-tag { padding: 2px 6px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .price-tag.buy { background: #28a745; color: white; }
        .price-tag.sell { background: #dc3545; color: white; }
        .market-stock-info { display: flex; justify-content: space-between; align-items: center; }
        .market-stock { display: flex; gap: 2px; flex-wrap: wrap; min-height: 24px; padding: 4px; background: white; border-radius: 4px; flex: 1; }
        .stock-block { width: 18px; height: 18px; background: #7c3aed; border-radius: 2px; }
        .stock-count { font-size: 12px; color: #666; margin-left: 10px; font-weight: bold; }
        
        /* 会社セクション */
        .companies-section { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .company-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 12px; }
        .company-card { border: 2px solid #dee2e6; border-radius: 6px; padding: 12px; background: #f8f9fa; }
        .company-card.player { border-color: #007bff; background: #e7f3ff; }
        .company-card.current-turn { border-color: #ffc107; box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.25); }
        .company-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .company-name { font-weight: bold; font-size: 14px; color: #2c3e50; }
        .company-cash { background: #28a745; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .company-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 8px; font-size: 12px; }
        .stat-item { background: white; padding: 4px 6px; border-radius: 3px; }
        .stat-item.capacity { background: #e7f3ff; font-weight: bold; }
        .personnel-section { display: flex; gap: 10px; margin-bottom: 8px; font-size: 12px; }
        .personnel-group { display: flex; align-items: center; gap: 4px; }
        .personnel-label { color: #666; font-size: 11px; }
        .personnel-dots { display: flex; gap: 2px; }
        .personnel-dot { width: 8px; height: 8px; background: #6c757d; border-radius: 50%; }
        
        /* 在庫セクション */
        .inventory-section { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px; }
        .inventory-box { background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 6px; }
        .inventory-label { font-size: 10px; color: #666; margin-bottom: 4px; text-align: center; }
        .inventory-blocks { display: flex; gap: 2px; flex-wrap: wrap; min-height: 20px; justify-content: center; }
        .inventory-block { width: 12px; height: 12px; border-radius: 2px; }
        .inventory-block.material { background: #7c3aed; }
        .inventory-block.wip { background: #8b5cf6; }
        .inventory-block.product { background: #7c3aed; }
        
        /* 機械表示 */
        .machine-section { margin-bottom: 8px; font-size: 11px; }
        .machine-item { background: white; padding: 3px 6px; border-radius: 3px; margin-bottom: 3px; display: inline-block; margin-right: 4px; }
        
        /* 倉庫表示 */
        .warehouse-section { margin-bottom: 8px; font-size: 11px; }
        .warehouse-item { background: #ffd700; padding: 3px 6px; border-radius: 3px; margin-bottom: 3px; display: inline-block; margin-right: 4px; color: #333; }
        
        .chips-section { margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6; font-size: 11px; }
        .chip-row { display: flex; align-items: center; gap: 4px; margin-bottom: 3px; }
        .chip-label { width: 80px; color: #6c757d; }
        .chip-dots { display: flex; gap: 3px; }
        .chip-dot { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #dee2e6; }
        .chip-dot.filled.computer { background: #10b981; }
        .chip-dot.filled.insurance { background: #f97316; }
        .chip-dot.filled.research { background: #3b82f6; }
        .chip-dot.filled.education { background: #eab308; }
        .chip-dot.filled.advertising { background: #ef4444; }
        
        /* アクションボタン */
        .action-section { background: white; border-radius: 8px; padding: 15px; margin-top: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
        .action-btn { padding: 10px; border: none; border-radius: 6px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .action-btn.primary { background: #007bff; color: white; }
        .action-btn.primary:hover { background: #0056b3; transform: translateY(-1px); }
        .action-btn.secondary { background: #6c757d; color: white; }
        .action-btn.secondary:hover { background: #545b62; }
        .action-btn.danger { background: #dc3545; color: white; }
        .action-btn.success { background: #28a745; color: white; }
        .action-btn.warning { background: #ffc107; color: black; }
        .action-btn.main { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 16px; padding: 15px; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* カード選択画面 */
        .card-choice-container { text-align: center; padding: 20px; }
        .card-choice-btn { margin: 10px; padding: 20px 40px; font-size: 18px; border-radius: 10px; }
        
        /* モーダル */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 8px; padding: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 18px; font-weight: bold; color: #2c3e50; }
        .close-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold; color: #495057; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; }
        .form-control:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
        .submit-btn { width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .submit-btn:hover { background: #218838; }
        
        /* 内訳表示 */
        .breakdown-list { background: #f8f9fa; border-radius: 4px; padding: 10px; margin-top: 10px; font-size: 13px; }
        .breakdown-item { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #dee2e6; }
        .breakdown-item:last-child { border-bottom: none; }
        .breakdown-total { font-weight: bold; color: #dc3545; padding-top: 8px; border-top: 2px solid #dee2e6; }
        
        /* 意思決定カード */
        .decision-card { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; margin: 10px 0; }
        .decision-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .decision-option { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .decision-option:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        
        /* リスクカード表示 */
        .risk-display { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; margin: 10px 0; }
        .risk-title { font-weight: bold; font-size: 20px; margin-bottom: 10px; }
        .risk-description { font-size: 16px; }
        
        /* 入札表示 */
        .bid-display { background: #e7f3ff; border: 2px solid #007bff; border-radius: 6px; padding: 15px; margin: 10px 0; }
        .bid-title { font-weight: bold; color: #004085; margin-bottom: 10px; }
        .bid-entries { display: grid; gap: 5px; }
        .bid-entry { display: flex; justify-content: space-between; padding: 5px; background: white; border-radius: 3px; }
        .bid-winner { background: #d4edda; font-weight: bold; }
        
        /* スマホ対応 */
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
            .period-info { grid-template-columns: 1fr 1fr; }
            .company-grid { grid-template-columns: 1fr; }
            .action-grid { grid-template-columns: 1fr; }
            .decision-options { grid-template-columns: 1fr; }
            
            /* スマホ版でカードを引くボタンを上部に */
            .mobile-card-btn { display: block; width: 100%; margin-bottom: 10px; }
        }
        @media (min-width: 769px) {
            .mobile-card-btn { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="period-info">
                <div class="info-item">
                    <span class="info-label">期</span>
                    <span class="info-value" id="currentPeriod">2</span>
                </div>
                <div class="info-item">
                    <span class="info-label">行</span>
                    <span class="info-value" id="currentRow">1/6</span>
                </div>
                <div class="info-item">
                    <span class="info-label">現在</span>
                    <span class="info-value" id="currentPlayer">あなた</span>
                </div>
                <div class="info-item">
                    <span class="info-label">自己資本</span>
                    <span class="info-value" id="equity">¥283</span>
                </div>
                <div class="info-item" onclick="showPeriodPaymentBreakdown()">
                    <span class="info-label">期末支払</span>
                    <span class="info-value" id="periodPayment">¥77</span>
                </div>
                <div class="info-item" onclick="showFixedCostBreakdown()">
                    <span class="info-label">固定費</span>
                    <span class="info-value" id="fixedCost">¥138</span>
                </div>
            </div>
        </div>
        
        <div class="main-layout">
            <div class="markets-section">
                <h2 class="section-title">市場</h2>
                <div id="marketsContainer"></div>
            </div>
            
            <div class="companies-section">
                <h2 class="section-title">会社盤</h2>
                <div class="company-grid" id="companiesContainer"></div>
            </div>
        </div>
        
        <div class="action-section">
            <h2 class="section-title">アクション</h2>
            <div class="action-grid" id="actionButtons"></div>
        </div>
    </div>
    
    <div id="modalContainer"></div>
    
    <script>
// MG Game Ultimate Edition - Complete Implementation
const gameState = {
    currentPeriod: 2,
    currentRow: 2,  // 2期は期首処理後2行目から開始（廃止予定）
    maxRows: 20,  // 現在の期の行数上限
    maxRowsByPeriod: {2: 20, 3: 30, 4: 34, 5: 35},  // 各期の行数上限
    currentPlayerIndex: 0,
    turnOrder: [],
    skipTurns: {},
    doNothingCount: {},
    usedRiskCards: [],
    usedDecisionCards: [],
    reverseOrder: false,
    turnReversed: false,  // 景気変動による逆回り
    periodStarted: false,
    waitingForBids: false,
    currentBids: [],
    bidMarkets: [],
    
    markets: [
        {name: '仙台', buyPrice: 10, sellPrice: 40, maxStock: 3, currentStock: 3, needsBid: true},
        {name: '札幌', buyPrice: 11, sellPrice: 36, maxStock: 4, currentStock: 4, needsBid: true},
        {name: '福岡', buyPrice: 12, sellPrice: 32, maxStock: 6, currentStock: 6, needsBid: true},
        {name: '名古屋', buyPrice: 13, sellPrice: 28, maxStock: 9, currentStock: 9, needsBid: true},
        {name: '大阪', buyPrice: 14, sellPrice: 24, maxStock: 13, currentStock: 13, needsBid: false},
        {name: '東京', buyPrice: 15, sellPrice: 20, maxStock: 20, currentStock: 20, needsBid: false},
        {name: '海外', buyPrice: 16, sellPrice: 16, maxStock: 45, currentStock: 21, needsBid: false}
    ],
    
    decisionCards: [
        {id: 1, name: '商品販売', description: '製品を市場に販売'},
        {id: 2, name: '材料購入', description: '材料を市場から購入'},
        {id: 3, name: '完成・投入', description: '材料→仕掛品→製品'},
        {id: 4, name: '採用', description: '人材を採用（最大3名）'},
        {id: 5, name: '設備投資', description: '機械を購入'},
        {id: 6, name: 'チップ購入', description: '研究・教育・広告チップ'},
        {id: 7, name: 'DO NOTHING', description: '何もしない（行消費なし）'}
    ],
    
    // リスクカード（64枚のPDFに基づく正確な実装が必要）
    // 注：材料暴落は存在しないカード
    riskCards: [
        {id: 1, name: 'クレーム発生', description: '本社経費▲5', type: 'cost'},
        {id: 2, name: 'クレーム発生', description: '本社経費▲5', type: 'cost'},
        {id: 3, name: '教育成功', description: '教育チップを持っていれば1個32円で販売（販売能力の範囲内、最高5個まで、仕入れ可）', type: 'benefit'},
        {id: 4, name: '教育成功', description: '教育チップを持っていれば1個32円で販売（販売能力の範囲内、最高5個まで、仕入れ可）', type: 'benefit'},
        {id: 5, name: '消費者運動発生', description: '商品の販売はできません（材料購入、完成・投入、DO NOTHINGは可能）', type: 'cost'},
        {id: 6, name: '消費者運動発生', description: '商品の販売はできません（材料購入、完成・投入、DO NOTHINGは可能）', type: 'cost'},
        {id: 7, name: '得意先倒産', description: '現金▲30（特別損失）', type: 'cost', period2Exempt: true},
        {id: 8, name: '得意先倒産', description: '現金▲30（特別損失）', type: 'cost', period2Exempt: true},
        {id: 9, name: '研究開発失敗', description: '青チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 10, name: '研究開発失敗', description: '青チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 11, name: '研究開発失敗', description: '青チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 12, name: '広告成功', description: '赤チップ1枚につき2個まで空いた市場へ独占販売可能（最高5個まで、仕入れ可）', type: 'benefit'},
        {id: 13, name: '広告成功', description: '赤チップ1枚につき2個まで空いた市場へ独占販売可能（最高5個まで、仕入れ可）', type: 'benefit'},
        {id: 14, name: '広告成功', description: '赤チップ1枚につき2個まで空いた市場へ独占販売可能（最高5個まで、仕入れ可）', type: 'benefit'},
        {id: 15, name: '労災発生', description: '生産活動はできません（材料購入、商品販売・入札、DO NOTHINGは可能）', type: 'cost'},
        {id: 16, name: '労災発生', description: '生産活動はできません（材料購入、商品販売・入札、DO NOTHINGは可能）', type: 'cost'},
        {id: 17, name: '広告政策失敗', description: '赤チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 18, name: '広告政策失敗', description: '赤チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 19, name: '特別サービス', description: '材料購入→1個10で5個まで or 広告の特別サービス1個20で2個まで可', type: 'benefit'},
        {id: 20, name: '特別サービス', description: '材料購入→1個10で5個まで or 広告の特別サービス1個20で2個まで可', type: 'benefit'},
        {id: 21, name: '返品発生', description: 'ストッカーから商品1個を営業所に戻し、売上欄に（▲1個、▲20）と記入', type: 'cost', period2Exempt: true},
        {id: 22, name: '返品発生', description: 'ストッカーから商品1個を営業所に戻し、売上欄に（▲1個、▲20）と記入', type: 'cost', period2Exempt: true},
        {id: 23, name: '返品発生', description: 'ストッカーから商品1個を営業所に戻し、売上欄に（▲1個、▲20）と記入', type: 'cost', period2Exempt: true},
        {id: 24, name: 'コンピュータートラブル', description: '製造経費▲10', type: 'cost'},
        {id: 25, name: 'コンピュータートラブル', description: '製造経費▲10', type: 'cost'},
        {id: 26, name: '商品の独占販売', description: 'セールスマン1人につき2個まで売れる 1個32でストッカーへ（最高5個まで 仕入れ可）', type: 'benefit'},
        {id: 27, name: '商品の独占販売', description: 'セールスマン1人につき2個まで売れる 1個32でストッカーへ（最高5個まで 仕入れ可）', type: 'benefit'},
        {id: 28, name: '商品の独占販売', description: 'セールスマン1人につき2個まで売れる 1個32でストッカーへ（最高5個まで 仕入れ可）', type: 'benefit'},
        {id: 29, name: '製造ミス発生', description: '仕掛品1個をストッカーへ', type: 'cost'},
        {id: 30, name: '製造ミス発生', description: '仕掛品1個をストッカーへ', type: 'cost'},
        {id: 31, name: '倉庫火災', description: '材料を全てストッカーへ 保険に加入していれば1個8の保険金が受け取れる（再加入5）', type: 'cost'},
        {id: 32, name: '倉庫火災', description: '材料を全てストッカーへ 保険に加入していれば1個8の保険金が受け取れる（再加入5）', type: 'cost'},
        {id: 33, name: '縁故採用', description: '本社経費▲5', type: 'cost'},
        {id: 34, name: '縁故採用', description: '本社経費▲5', type: 'cost'},
        {id: 35, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 36, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 37, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 38, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 39, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 40, name: '研究開発成功', description: '青チップ1枚につき2個まで売れる 1個32でストッカーへ（販売能力の範囲内、最高5個まで 仕入れ不可）', type: 'benefit'},
        {id: 41, name: '各社共通', description: '3個までを1個12で購入可（まず市場から、不足分はストッカーから）', type: 'special'},
        {id: 42, name: '各社共通', description: '3個までを1個12で購入可（まず市場から、不足分はストッカーから）', type: 'special'},
        {id: 43, name: 'ストライキ発生', description: '1回休み', type: 'cost'},
        {id: 44, name: 'ストライキ発生', description: '1回休み', type: 'cost'},
        {id: 45, name: '盗難発見', description: '商品を2個ストッカーへ 保険に加入していれば1個10の保険金が受け取れる（再加入5）', type: 'cost'},
        {id: 46, name: '盗難発見', description: '商品を2個ストッカーへ 保険に加入していれば1個10の保険金が受け取れる（再加入5）', type: 'cost'},
        {id: 47, name: '長期労務紛争', description: '2回休み', type: 'cost'},
        {id: 48, name: '長期労務紛争', description: '2回休み', type: 'cost'},
        {id: 49, name: '設計トラブル発生', description: '製造経費▲10', type: 'cost'},
        {id: 50, name: '設計トラブル発生', description: '製造経費▲10', type: 'cost'},
        {id: 51, name: 'ワーカー退職', description: '労務費▲5', type: 'cost'},
        {id: 52, name: 'ワーカー退職', description: '労務費▲5', type: 'cost'},
        {id: 53, name: '景気変動', description: '逆回り', type: 'special'},
        {id: 54, name: '景気変動', description: '逆回り', type: 'special'},
        {id: 55, name: '教育失敗', description: '黄チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 56, name: '教育失敗', description: '黄チップ1枚返却（まず会社盤から、なければ次繰盤から）', type: 'cost'},
        {id: 57, name: 'セールスマン退職', description: '本社人件費▲5', type: 'cost'},
        {id: 58, name: 'セールスマン退職', description: '本社人件費▲5', type: 'cost'},
        {id: 59, name: '社長、病気で倒れる', description: '1回休み', type: 'cost'},
        {id: 60, name: '社長、病気で倒れる', description: '1回休み', type: 'cost'},
        {id: 61, name: '不良在庫発生', description: '総在庫が20個を超えるものは全てストッカーへ 1個10の保険金（製品から順に）', type: 'cost'},
        {id: 62, name: '不良在庫発生', description: '総在庫が20個を超えるものは全てストッカーへ 1個10の保険金（製品から順に）', type: 'cost'},
        {id: 63, name: '機械故障', description: '製造経費▲5', type: 'cost'},
        {id: 64, name: '機械故障', description: '製造経費▲5', type: 'cost'}
    ],
    
    companies: []
};

// Initialize companies
function initializeCompanies() {
    const companyTypes = [
        {name: 'あなた', type: 'player', strategy: 'player'},
        {name: 'アグレス社', type: 'ai', strategy: 'aggressive'},     // 積極的：生産・販売重視、戦略チップ積極購入
        {name: 'バランス社', type: 'ai', strategy: 'balanced'},       // バランス型：全体的に平均的
        {name: '堅実社', type: 'ai', strategy: 'conservative'},       // 保守的：リスク回避、現金重視
        {name: '価格破壊社', type: 'ai', strategy: 'price_focused'},  // 価格競争：低価格入札重視  
        {name: 'テクノ社', type: 'ai', strategy: 'tech_focused'}      // 技術重視：機械・チップ投資積極的
    ];
    
    gameState.companies = companyTypes.map(ct => ({
        name: ct.name,
        type: ct.type,
        strategy: ct.strategy || ct.type,  // strategyまたはtypeを使用
        cash: 137,  // 2期開始時の現金（期初処理前）
        equity: 283,
        loans: 0,
        shortLoans: 0,
        currentRow: 1,  // 各社の現在の行数
        materials: 1,  // 2期開始時の初期在庫
        wip: 2,         // 2期開始時の初期在庫
        products: 1,    // 2期開始時の初期在庫
        workers: 1,
        salesmen: 1,
        machines: [{type: 'small', attachments: 0}],
        warehouses: 0,  // 無災害倉庫の数
        warehouseLocation: 'materials',  // 'materials' or 'products'
        chips: {
            computer: 0,
            insurance: 0,
            research: 0,
            education: 0,
            advertising: 0
        },
        nextPeriodChips: {
            research: 0,
            education: 0,
            advertising: 0
        },
        periodStartInventory: {
            materials: 1,
            wip: 2,
            products: 1
        },
        skipTurns: 0,
        rowsUsed: 0,
        decisionCard: null,
        totalSales: 0,  // PQ計算用
        totalMaterialCost: 0,  // VQ計算用
        totalProductionCost: 0,  // VQ計算用
        aiStrategy: ct.type
    }));
}

// Calculate manufacturing capacity
function getManufacturingCapacity(company) {
    let baseMachineCapacity = 0;
    company.machines.forEach(machine => {
        if (machine.type === 'small') {
            baseMachineCapacity += machine.attachments > 0 ? 2 : 1;
        } else if (machine.type === 'large') {
            baseMachineCapacity += 4;
        }
    });
    
    // ワーカーが0人なら製造能力0
    if (company.workers === 0) {
        return 0;
    }
    
    // 機械台数とワーカー人数をチェック
    const machineCount = company.machines.length;
    if (company.workers < machineCount) {
        // ワーカーが機械台数より少ない場合、ワーカー人数が上限
        return company.workers;
    }
    
    // 機械能力の計算
    // 基本機械能力 + コンピュータチップ(+1) + 教育チップ(+1)
    let manufacturingCapacity = baseMachineCapacity + (company.chips.computer || 0);
    
    // 教育チップで製造能力+1（2期は最大1）
    let educationBonus = company.chips.education || 0;
    if (gameState.currentPeriod === 2 && educationBonus > 1) {
        educationBonus = 1;  // 2期は教育チップ2枚でも効果は1
    }
    manufacturingCapacity += educationBonus;
    
    return manufacturingCapacity;
}

// Calculate sales capacity
function getSalesCapacity(company) {
    // セールスマン×2
    const baseCapacity = company.salesmen * 2;
    
    // 広告チップ効果
    let adBonus = 0;
    if (company.type === 'ai' || company.type === 'player') {
        // AIもプレイヤーも広告チップ1枚あたり2個の販売能力
        // ただしセールスマン1人あたり最大2枚まで
        adBonus = Math.min(company.chips.advertising * 2, company.salesmen * 2 * 2);
    }
    
    // 基本販売能力
    let salesCapacity = baseCapacity + adBonus;
    
    // 教育チップで販売能力自体に+1（2期は最大1）
    let educationBonus = company.chips.education || 0;
    if (gameState.currentPeriod === 2 && educationBonus > 1) {
        educationBonus = 1;  // 2期は教育チップ2枚でも効果は1
    }
    salesCapacity += educationBonus;
    
    return salesCapacity;
}

// Get price competitiveness
function getPriceCompetitiveness(company, companyIndex = null) {
    // companyIndexが渡されない場合は、companiesから検索
    if (companyIndex === null) {
        companyIndex = gameState.companies.indexOf(company);
    }
    
    // 親（現在のターンプレイヤー）は追加で2円の価格競争力
    const isParent = (companyIndex === gameState.currentPlayerIndex);
    const parentBonus = isParent ? 2 : 0;
    return (company.chips.research * 2) + parentBonus;  // 研究チップ1枚につき2円 + 親ボーナス
}

// Calculate salary costs (給料)
function calculateSalaryCost(company, period) {
    let cost = 0;
    
    // 各期の単価
    const costPerUnit = {2: 22, 3: 29, 4: 31, 5: 34};
    const totalPersonnelCost = {2: 11, 3: 14, 4: 16, 5: 17};
    
    // 機械台数による費用
    const machineCount = company.machines.length;
    cost += machineCount * costPerUnit[period];
    
    // ワーカー給与
    cost += company.workers * costPerUnit[period];
    
    // セールスマン給与
    cost += company.salesmen * costPerUnit[period];
    
    // ワーカー+セールスマンの合計人数による追加費用
    const totalPersonnel = company.workers + company.salesmen;
    cost += totalPersonnel * totalPersonnelCost[period];
    
    return cost;
}

// Calculate depreciation
function calculateDepreciation(company, period) {
    let cost = 0;
    
    company.machines.forEach(machine => {
        if (machine.type === 'small') {
            if (machine.attachments > 0) {
                // 小型+アタッチメント
                cost += period === 2 ? 13 : 26;
            } else {
                // 小型のみ
                cost += period === 2 ? 10 : 20;
            }
        } else if (machine.type === 'large') {
            // 大型
            cost += period === 2 ? 20 : 40;
        }
    });
    
    return cost;
}

// Calculate period end payment (期末支払)
function calculatePeriodPayment(company, useEndOfPeriod = false) {
    const period = gameState.currentPeriod;
    let payment = 0;
    
    // 給料（期末計算時は期末時点の人数を使用）
    if (useEndOfPeriod && company.endOfPeriodStats) {
        // 期末時点の人数・機械台数で計算
        const costPerUnit = {2: 22, 3: 29, 4: 31, 5: 34};
        const totalPersonnelCost = {2: 11, 3: 14, 4: 16, 5: 17};
        
        payment += company.endOfPeriodStats.machines * costPerUnit[period];
        payment += company.endOfPeriodStats.workers * costPerUnit[period];
        payment += company.endOfPeriodStats.salesmen * costPerUnit[period];
        payment += (company.endOfPeriodStats.workers + company.endOfPeriodStats.salesmen) * totalPersonnelCost[period];
    } else {
        payment += calculateSalaryCost(company, period);
    }
    
    // 長期借入返済（元本の10%以上）
    if (company.loans > 0) {
        payment += Math.floor(company.loans * 0.1);
    }
    
    // 短期借入返済（元本の20%以上）
    if (company.shortLoans > 0) {
        payment += Math.floor(company.shortLoans * 0.2);
    }
    
    return payment;
}

// Calculate chip costs
function calculateChipCost(company, period) {
    let cost = 0;
    
    // コンピュータ・保険
    cost += (company.chips.computer || 0) * 20;
    cost += (company.chips.insurance || 0) * 5;
    
    // 戦略チップ
    if (period === 2) {
        // 2期は各1枚分のみ固定費
        if (company.chips.research > 0) cost += 20;
        if (company.chips.education > 0) cost += 20;
        if (company.chips.advertising > 0) cost += 20;
    } else {
        // 3期以降
        cost += (company.chips.research || 0) * 40;  // 特急
        cost += (company.chips.education || 0) * 40; // 特急
        cost += (company.chips.advertising || 0) * 40; // 特急
        cost += (company.nextPeriodChips.research || 0) * 20; // 繰越
        cost += (company.nextPeriodChips.education || 0) * 20; // 繰越
        cost += (company.nextPeriodChips.advertising || 0) * 20; // 繰越
    }
    
    return cost;
}

// Calculate fixed costs (固定費) - 税金除外
function calculateFixedCost(company) {
    const period = gameState.currentPeriod;
    let cost = 0;
    
    // 給料
    cost += calculateSalaryCost(company, period);
    
    // 借入金利（すでに支払い済み）
    // 長期借入は借入時に10%支払い済み
    // 短期借入は借入時に支払い済み
    
    // コンピュータ・保険費用
    cost += company.chips.computer * 20;
    cost += company.chips.insurance * 5;
    
    // 戦略チップ費用
    if (period === 2) {
        // 2期：各チップ1枚分のみ固定費計上
        if (company.chips.research > 0) cost += 20;
        if (company.chips.education > 0) cost += 20;
        if (company.chips.advertising > 0) cost += 20;
    } else {
        // 3-5期：実際の使用枚数分
        cost += company.chips.research * 40;  // 特急扱い
        cost += company.chips.education * 40;
        cost += company.chips.advertising * 40;
        // 次期繰り越し分
        cost += company.nextPeriodChips.research * 20;
        cost += company.nextPeriodChips.education * 20;
        cost += company.nextPeriodChips.advertising * 20;
    }
    
    // 減価償却費
    cost += calculateDepreciation(company, period);
    
    // 機械故障による追加固定費
    if (company.additionalFixedCost) {
        cost += company.additionalFixedCost;
    }
    
    // リスクに伴う経費・配置転換に伴う経費（発生時に加算）
    
    // 倉庫費用（無災害倉庫は購入時のみ20円、期末費用なし）
    
    return cost;
}

// Calculate VQ (変動費総額)
function calculateVQ(company) {
    // VQ = ①材料購入費 + ②完成投入費 + ③期末在庫評価額 - ④期首在庫評価額
    
    // ①材料購入費（期中の合計）
    const materialCost = company.totalMaterialCost || 0;
    
    // ②完成・投入費（期中の合計）
    const productionCost = company.totalProductionCost || 0;
    
    // ③期末在庫評価額
    // 材料:13円、仕掛品:14円、製品:15円
    const endInventoryValue = (company.materials * 13) + 
                             (company.wip * 14) + 
                             (company.products * 15);
    
    // ④期首在庫評価額
    const startInventoryValue = (company.periodStartInventory.materials * 13) + 
                               (company.periodStartInventory.wip * 14) + 
                               (company.periodStartInventory.products * 15);
    
    // VQ = ①+②+③-④
    return materialCost + productionCost + endInventoryValue - startInventoryValue;
}

// Show period payment breakdown
function showPeriodPaymentBreakdown() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    
    let html = '<div class="breakdown-list">';
    
    // 給料の詳細内訳
    if (company.endOfPeriodStats) {
        // 期末時点の人数・機械台数を使用
        const stats = company.endOfPeriodStats;
        const costPerUnit = {2: 22, 3: 29, 4: 31, 5: 34};
        const totalPersonnelCost = {2: 11, 3: 14, 4: 16, 5: 17};
        
        const machineCost = stats.machines * costPerUnit[period];
        const workerCost = stats.workers * costPerUnit[period];
        const salesmanCost = stats.salesmen * costPerUnit[period];
        const personnelCost = (stats.workers + stats.salesmen) * totalPersonnelCost[period];
        
        html += `<div class="breakdown-item"><span>【給料内訳】</span><span></span></div>`;
        html += `<div class="breakdown-item"><span>　機械費 (${stats.machines}台×¥${costPerUnit[period]})</span><span>¥${machineCost}</span></div>`;
        html += `<div class="breakdown-item"><span>　ワーカー給料 (${stats.workers}人×¥${costPerUnit[period]})</span><span>¥${workerCost}</span></div>`;
        html += `<div class="breakdown-item"><span>　セールスマン給料 (${stats.salesmen}人×¥${costPerUnit[period]})</span><span>¥${salesmanCost}</span></div>`;
        html += `<div class="breakdown-item"><span>　人員合計費 (${stats.workers + stats.salesmen}人×¥${totalPersonnelCost[period]})</span><span>¥${personnelCost}</span></div>`;
        html += `<div class="breakdown-item"><span>給料合計</span><span>¥${machineCost + workerCost + salesmanCost + personnelCost}</span></div>`;
    } else {
        // 通常の給料計算
        const salaryCost = calculateSalaryCost(company, period);
        html += `<div class="breakdown-item"><span>給料</span><span>¥${salaryCost}</span></div>`;
    }
    
    // 長期借入返済
    if (company.loans > 0) {
        const loanPayment = Math.floor(company.loans * 0.1);
        html += `<div class="breakdown-item"><span>長期借入返済 (¥${company.loans}×10%)</span><span>¥${loanPayment}</span></div>`;
    }
    
    // 短期借入返済
    if (company.shortLoans > 0) {
        const shortLoanPayment = Math.floor(company.shortLoans * 0.2);
        html += `<div class="breakdown-item"><span>短期借入返済 (¥${company.shortLoans}×20%)</span><span>¥${shortLoanPayment}</span></div>`;
    }
    
    const total = calculatePeriodPayment(company, company.endOfPeriodStats ? true : false);
    html += `<div class="breakdown-item breakdown-total"><span>合計</span><span>¥${total}</span></div>`;
    html += '</div>';
    
    showModal('期末支払内訳', html);
}

// Show fixed cost breakdown
function showFixedCostBreakdown() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    
    let html = '<div class="breakdown-list">';
    
    // 給料
    const salaryCost = calculateSalaryCost(company, period);
    html += `<div class="breakdown-item"><span>給料</span><span>¥${salaryCost}</span></div>`;
    
    // コンピュータ・保険
    if (company.chips.computer > 0) {
        html += `<div class="breakdown-item"><span>コンピュータ(${company.chips.computer}枚)</span><span>¥${company.chips.computer * 20}</span></div>`;
    }
    
    if (company.chips.insurance > 0) {
        html += `<div class="breakdown-item"><span>保険(${company.chips.insurance}枚)</span><span>¥${company.chips.insurance * 5}</span></div>`;
    }
    
    // 戦略チップ
    if (period === 2) {
        if (company.chips.research > 0) html += `<div class="breakdown-item"><span>研究(1枚分)</span><span>¥20</span></div>`;
        if (company.chips.education > 0) html += `<div class="breakdown-item"><span>教育(1枚分)</span><span>¥20</span></div>`;
        if (company.chips.advertising > 0) html += `<div class="breakdown-item"><span>広告(1枚分)</span><span>¥20</span></div>`;
    } else {
        if (company.chips.research > 0) html += `<div class="breakdown-item"><span>研究・特急(${company.chips.research}枚)</span><span>¥${company.chips.research * 40}</span></div>`;
        if (company.chips.education > 0) html += `<div class="breakdown-item"><span>教育・特急(${company.chips.education}枚)</span><span>¥${company.chips.education * 40}</span></div>`;
        if (company.chips.advertising > 0) html += `<div class="breakdown-item"><span>広告・特急(${company.chips.advertising}枚)</span><span>¥${company.chips.advertising * 40}</span></div>`;
        if (company.nextPeriodChips.research > 0) html += `<div class="breakdown-item"><span>研究・繰越(${company.nextPeriodChips.research}枚)</span><span>¥${company.nextPeriodChips.research * 20}</span></div>`;
        if (company.nextPeriodChips.education > 0) html += `<div class="breakdown-item"><span>教育・繰越(${company.nextPeriodChips.education}枚)</span><span>¥${company.nextPeriodChips.education * 20}</span></div>`;
        if (company.nextPeriodChips.advertising > 0) html += `<div class="breakdown-item"><span>広告・繰越(${company.nextPeriodChips.advertising}枚)</span><span>¥${company.nextPeriodChips.advertising * 20}</span></div>`;
    }
    
    // 減価償却費
    const depreciationCost = calculateDepreciation(company, period);
    if (depreciationCost > 0) {
        html += `<div class="breakdown-item"><span>減価償却費</span><span>¥${depreciationCost}</span></div>`;
    }
    
    const total = calculateFixedCost(company);
    html += `<div class="breakdown-item breakdown-total"><span>合計</span><span>¥${total}</span></div>`;
    html += '</div>';
    
    showModal('固定費内訳', html);
}

// Start period
function startPeriod() {
    if (gameState.periodStarted) return;
    
    let content = `
        <div class="decision-card">
            <h3>第${gameState.currentPeriod}期開始</h3>
            <p>期首処理を行います</p>
        </div>
    `;
    
    // 3期以降は借入と無災害倉庫の選択
    if (gameState.currentPeriod >= 3) {
        const company = gameState.companies[0];
        const maxLoan = Math.round(company.equity * 0.5);
        
        content += `
            <div class="form-group">
                <label class="form-label">長期借入（自己資本の0.5倍まで: ¥${maxLoan}）</label>
                <select id="loanAmount" class="form-control">
                    <option value="0">借りない</option>
                    <option value="50">¥50</option>
                    <option value="100">¥100</option>
                    ${maxLoan >= 150 ? '<option value="150">¥150</option>' : ''}
                    ${maxLoan >= 200 ? '<option value="200">¥200</option>' : ''}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">無災害倉庫（¥20/個、容量12）</label>
                <select id="warehouseCount" class="form-control">
                    <option value="0">買わない</option>
                    <option value="1">1個買う</option>
                    <option value="2">2個買う</option>
                </select>
            </div>
        `;
    }
    
    content += `
        <div class="form-group">
            <label class="form-label">コンピュータチップ（生産+1）</label>
            <div>価格: ¥20/個（期首は1個限定）</div>
            <select id="computerChips" class="form-control">
                <option value="0">0個</option>
                <option value="1" selected>1個</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">保険チップ（災害対策）</label>
            <div>価格: ¥5/個（期首は1個限定）</div>
            <select id="insuranceChips" class="form-control">
                <option value="0">0個</option>
                <option value="1" selected>1個</option>
            </select>
        </div>
        <button class="submit-btn" onclick="processPeriodStart()">期首処理を完了</button>
    `;
    
    showModal('期首処理', content);
}

// Process period start
function processPeriodStart() {
    const company = gameState.companies[0];
    let totalCost = 0;
    
    // 借入処理（3期以降）
    if (gameState.currentPeriod >= 3) {
        const loanAmount = parseInt(document.getElementById('loanAmount')?.value || 0);
        if (loanAmount > 0) {
            const interest = Math.floor(loanAmount * 0.1);
            company.cash += loanAmount - interest;  // 利息を引いた額が入金
            company.loans += loanAmount;
            console.log(`長期借入: ¥${loanAmount} (利息¥${interest}支払い済み)`);
        }
        
        // 無災害倉庫購入
        const warehouseCount = parseInt(document.getElementById('warehouseCount')?.value || 0);
        if (warehouseCount > 0) {
            totalCost += warehouseCount * 20;
            company.warehouses += warehouseCount;
        }
    }
    
    // コンピュータ・保険購入
    const computerQty = parseInt(document.getElementById('computerChips').value || 0);
    const insuranceQty = parseInt(document.getElementById('insuranceChips').value || 0);
    
    totalCost += (computerQty * 20) + (insuranceQty * 5);
    
    if (company.cash < totalCost) {
        alert('現金が不足しています！');
        return;
    }
    
    company.cash -= totalCost;
    company.chips.computer = Math.min(3, company.chips.computer + computerQty);
    company.chips.insurance = Math.min(3, company.chips.insurance + insuranceQty);
    
    // AI companies also process period start
    for (let i = 1; i < gameState.companies.length; i++) {
        const aiCompany = gameState.companies[i];
        // Simple AI logic
        if (aiCompany.cash >= 25) {
            aiCompany.cash -= 25;
            aiCompany.chips.computer = 1;
            aiCompany.chips.insurance = 1;
        }
    }
    
    gameState.periodStarted = true;
    closeModal();
    updateDisplay();
    
    // Show turn start options
    showTurnStartOptions();
}

// Show turn start options
function showTurnStartOptions() {
    if (gameState.currentPlayerIndex !== 0) return;
    
    const content = `
        <div class="card-choice-container">
            <h2>あなたのターン</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button class="action-btn main card-choice-btn" onclick="drawCard()" style="flex: 2;">カードを引く</button>
                <button class="action-btn secondary" onclick="viewGameState()" style="flex: 1; font-size: 12px;">全体を見る</button>
            </div>
            <div style="margin-top: 20px;">
                <p>その他のアクション（Bルール）</p>
                <button class="action-btn secondary" onclick="showInsurancePurchaseModal()">保険チップ購入</button>
                <button class="action-btn secondary" onclick="showWarehouseModal()">無災害倉庫を購入</button>
                <button class="action-btn secondary" onclick="showReassignModal()">配置転換</button>
                <button class="action-btn secondary" onclick="showSellMachineModal()">機械売却</button>
            </div>
        </div>
    `;
    
    showModal('行動選択', content);
}

// View game state - 全体を見る機能
function viewGameState() {
    closeModal();
    updateDisplay();
    
    // Show game state details
    setTimeout(() => {
        const player = gameState.companies[0];
        const periodPayment = calculatePeriodPayment(player);
        const fixedCost = calculateFixedCost(player);
        
        alert(`【現在の状況】\n` +
              `期: ${gameState.currentPeriod}期 ${gameState.currentRow}/${gameState.maxRows}行目\n` +
              `現金: ¥${player.cash}\n` +
              `期末支払: ¥${periodPayment}\n` +
              `固定費: ¥${fixedCost}\n` +
              `\n市場と会社盤が表示されています。\n確認後、行動を選択してください。`);
        showTurnStartOptions();
    }, 100);
}

// Draw card (80% decision, 20% risk)
function drawCard() {
    closeModal();
    
    if (Math.random() < 0.8) {
        showDecisionCard();
    } else {
        drawRiskCard();
    }
}

// Show decision card
function showDecisionCard() {
    const company = gameState.companies[0];
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    
    const content = `
        <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <h4 style="margin: 0 0 10px 0;">あなたの会社盤</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 12px;">
                <div>現金: ¥${company.cash}</div>
                <div>製造能力: ${mfgCapacity}</div>
                <div>販売能力: ${salesCapacity}</div>
                <div>材料: ${company.materials}</div>
                <div>仕掛品: ${company.wip}</div>
                <div>製品: ${company.products}</div>
                <div>ワーカー: ${company.workers}</div>
                <div>セールス: ${company.salesmen}</div>
                <div>機械: ${company.machines.length}</div>
                <div>研究: ${company.chips.research}</div>
                <div>教育: ${company.chips.education}</div>
                <div>広告: ${company.chips.advertising}</div>
            </div>
        </div>
        <div class="decision-card">
            <h3>意思決定カード</h3>
            <p>アクションを選択してください</p>
        </div>
        <div class="decision-options">
            ${gameState.decisionCards.map(card => `
                <div class="decision-option" onclick="selectDecisionCard(${card.id})">
                    <strong>${card.name}</strong><br>
                    <small>${card.description}</small>
                </div>
            `).join('')}
        </div>
    `;
    
    showModal('意思決定カード', content);
}

// Select decision card
function selectDecisionCard(cardId) {
    const card = gameState.decisionCards.find(c => c.id === cardId);
    gameState.companies[0].decisionCard = card;
    
    closeModal();
    
    // Execute decision card action
    switch(cardId) {
        case 1: showSalesModal(); break;
        case 2: showBuyMaterialsModal(); break;
        case 3: showProductionModal(); break;
        case 4: showHireModal(); break;
        case 5: showMachineModal(); break;
        case 6: showChipPurchaseModal(); break;  // チップ購入
        case 7: doNothing(); break;
    }
}

// Draw risk card
function drawRiskCard() {
    const availableCards = gameState.riskCards.filter(card => {
        if (gameState.currentPeriod === 2 && card.period2Exempt) return false;
        return !gameState.usedRiskCards.includes(card.id);
    });
    
    if (availableCards.length === 0) {
        showDecisionCard();
        return;
    }
    
    const card = availableCards[Math.floor(Math.random() * availableCards.length)];
    gameState.usedRiskCards.push(card.id);
    
    const content = `
        <div class="risk-display">
            <div class="risk-title">リスクカード</div>
            <div class="risk-title">${card.name}</div>
            <div class="risk-description">${card.description}</div>
        </div>
        <button class="submit-btn" onclick="applyRiskCard(${card.id})">適用</button>
    `;
    
    showModal('リスクカード', content);
}

// Apply risk card
function applyRiskCard(cardId) {
    const company = gameState.companies[0];
    const card = gameState.riskCards.find(c => c.id === cardId);
    let rowUsed = true;
    
    switch(cardId) {
        case 3: // 教育成功
        case 4: // 教育成功
            if (company.chips.education > 0) {
                const salesCapacity = getSalesCapacity(company);
                const maxSell = Math.min(salesCapacity, 5);
                // 仕入れ可能なので、製品がなくても販売可能
                const availableProducts = company.products;
                let sellQty = Math.min(maxSell, availableProducts);
                
                // 製品が足りない場合は仕入れる
                if (sellQty < maxSell) {
                    const needToBuy = maxSell - sellQty;
                    const buyCost = needToBuy * 20; // 仕入れ単価は20円と仮定
                    if (company.cash >= buyCost) {
                        company.cash -= buyCost;
                        sellQty = maxSell;
                        alert(`教育成功！${needToBuy}個を仕入れて、合計${sellQty}個を販売します`);
                    }
                }
                
                if (sellQty > 0) {
                    const revenue = sellQty * 32;
                    company.cash += revenue;
                    company.products -= Math.min(availableProducts, sellQty);
                    company.totalSales += revenue;
                    alert(`教育成功！${sellQty}個を¥${revenue}で販売しました`);
                } else {
                    alert('販売能力または資金不足のため効果なし');
                    rowUsed = false;
                }
            } else {
                alert('教育チップを持っていないため効果なし');
                rowUsed = false;
            }
            break;
        case 7: // 臨時収入
            company.cash += 20;
            alert('20円の臨時収入を得ました！');
            break;
        case 8: // 臨時支出
            company.cash = Math.max(0, company.cash - 20);
            alert('20円の臨時支出が発生しました');
            break;
        case 11: // 倉庫火災
            if (company.warehouses > 0 && company.warehouseLocation === 'materials' && company.materials <= 12 * company.warehouses) {
                alert('無災害倉庫により火災を回避しました！');
            } else if (company.chips.insurance > 0) {
                const compensation = company.materials * 8;
                company.cash += compensation;
                company.materials = 0;
                company.chips.insurance = 0;  // 保険使用で消費
                alert(`火災発生！保険金¥${compensation}を受け取りました\n（保険チップは消費されました）`);
            } else {
                company.materials = 0;
                alert('火災発生！材料が全て失われました\n（保険未加入）');
            }
            break;
        case 24: // 盗難発生
        case 25:
            if (company.warehouses > 0 && company.warehouseLocation === 'products' && company.products <= 12 * company.warehouses) {
                alert('無災害倉庫により盗難を回避しました！');
            } else if (company.chips.insurance > 0) {
                const stolen = Math.min(2, company.products);
                const compensation = stolen * 14;  // 製品は1個14円の保険金
                company.cash += compensation;
                company.products -= stolen;
                // 海外市場に移動
                const overseasMarket = gameState.markets.find(m => m.name === '海外');
                if (overseasMarket) {
                    overseasMarket.currentStock += stolen;
                }
                company.chips.insurance = 0;  // 保険使用で消費
                alert(`盗難発生！\n製品${stolen}個が海外市場へ移動\n保険金¥${compensation}を受け取りました\n（保険チップは消費されました）`);
            } else {
                const stolen = Math.min(2, company.products);
                company.products -= stolen;
                // 海外市場に移動
                const overseasMarket = gameState.markets.find(m => m.name === '海外');
                if (overseasMarket) {
                    overseasMarket.currentStock += stolen;
                }
                alert(`盗難発生！\n製品${stolen}個が海外市場へ移動しました\n（保険未加入）`);
            }
            break;
        case 13: // 各社共通
        case 41:
        case 42:
            // 全社共通購入処理
            executeAllCompaniesCommonPurchase();
            rowUsed = false;
            break;
        case 35: // 研究開発成功
        case 36:
        case 37:
        case 38:
        case 39:
        case 40:
            if (company.chips.research > 0 && company.products > 0) {
                const salesCapacity = company.salesmen * 2 + company.chips.advertising + company.chips.education;
                const sellQty = Math.min(company.chips.research * 2, company.products, salesCapacity, 5);
                const revenue = sellQty * 32;
                company.cash += revenue;
                company.products -= sellQty;
                company.totalSales += revenue;
                alert(`研究開発成功！\n青チップ${company.chips.research}枚で最大${company.chips.research * 2}個販売可能\n販売能力: ${salesCapacity}個\n実際に${sellQty}個を¥32で強制販売\n入金額: ¥${revenue}`);
            } else if (company.chips.research === 0) {
                alert('研究開発成功！\nしかし青チップがないため販売できません');
            } else {
                alert('研究開発成功！\nしかし製品がないため販売できません');
                rowUsed = false;
            }
            break;
        case 15: // 労災発生
        case 16:
            company.cannotProduce = true;
            alert('労災発生！\n生産活動はできません\n（材料購入、商品販売・入札、DO NOTHINGは可能）');
            rowUsed = false;
            break;
        case 17: // 長期労務紛争
            company.skipTurns = 2;
            alert('長期労務紛争！2回休みです（行消費なし）');
            rowUsed = false;
            break;
        case 18: // 社長病気
            company.skipTurns = 1;
            alert('社長が病気！次の行は休みです（行消費なし）');
            rowUsed = false;
            break;
        case 19: // 特別サービス
        case 20: // 特別サービス
            showSpecialServiceModal();
            rowUsed = false;
            break;
        case 21: // 返品発生
        case 22: // 返品発生
        case 23: // 返品発生
            if (gameState.currentPeriod !== 2) {
                // 海外市場から1個戻ってくる
                company.products = Math.min(company.products + 1, 999);
                company.totalSales -= 20;
                alert('返品発生！海外から商品1個が戻り、売上▲20円');
            } else {
                alert('2期目は返品免除');
                rowUsed = false;
            }
            break;
        case 26: // 商品の独占販売
        case 27: // 商品の独占販売
        case 28: // 商品の独占販売
            const maxSellBySalesmen = company.salesmen * 2;
            const actualSell = Math.min(maxSellBySalesmen, company.products, 5);
            if (actualSell > 0) {
                const revenue = actualSell * 32;
                company.cash += revenue;
                company.products -= actualSell;
                company.totalSales += revenue;
                alert(`商品の独占販売！${actualSell}個を¥${revenue}で販売（セールスマン${company.salesmen}人×2個まで、最高5個）`);
            } else {
                alert('セールスマンがいないか製品がないため効果なし');
                rowUsed = false;
            }
            break;
        case 29: // 製造ミス発生
        case 30: // 製造ミス発生
            if (company.wip > 0) {
                company.wip--;
                alert('製造ミス発生！仕掛品1個を海外市場へ返却');
            } else {
                alert('仕掛品がないため効果なし');
                rowUsed = false;
            }
            break;
        case 33: // 縁故採用
        case 34:
            // 現金5円減少 + 固定費5円追加 + ワーカーまたはセールスマン1名追加
            company.cash = Math.max(0, company.cash - 5);
            company.specialLoss = (company.specialLoss || 0) + 5; // 固定費に5円追加
            showHiringChoiceModal(); // ワーカーかセールスマンを選択
            rowUsed = false;
            break;
        case 51: // ワーカー退職
        case 52:
            company.cash = Math.max(0, company.cash - 5);
            if (company.workers > 0) {
                company.workers--;
                alert('ワーカー退職！\n労務費▲5\nワーカー1人退職');
            } else {
                alert('ワーカー退職！\n労務費▲5\n（ワーカーがいないため退職なし）');
            }
            break;
        case 53: // 景気変動
        case 54: // 景気変動
            // ターン順を逆転
            gameState.turnReversed = !gameState.turnReversed;
            alert(`景気変動！ターン順が${gameState.turnReversed ? '逆回り' : '正順'}になりました`);
            break;
        case 55: // 教育失敗
        case 56:
            if (company.chips.education > 0) {
                company.chips.education--;
                alert('教育失敗！\n黄チップ1枚返却');
            } else {
                alert('教育失敗！\n（黄チップがないため効果なし）');
                rowUsed = false;
            }
            break;
        case 57: // セールスマン退職
        case 58:
            company.cash = Math.max(0, company.cash - 5);
            if (company.salesmen > 0) {
                company.salesmen--;
                alert('セールスマン退職！\n本社人件費▲5\nセールスマン1人退職');
            } else {
                alert('セールスマン退職！\n本社人件費▲5\n（セールスマンがいないため退職なし）');
            }
            break;
        case 59: // 社長病気
        case 60:
            company.skipTurns = 1;
            alert('社長が病気！次の行は休みです（行消費なし）');
            rowUsed = false;
            break;
        case 61: // 不良在庫発生
        case 62: // 不良在庫発生
            let totalCompensation = 0;
            // 製品から順に処理
            if (company.products > 20) {
                const excess = company.products - 20;
                totalCompensation += excess * 10;
                company.products = 20;
            }
            if (company.wip > 20) {
                const excess = company.wip - 20;
                totalCompensation += excess * 10;
                company.wip = 20;
            }
            if (company.materials > 20) {
                const excess = company.materials - 20;
                totalCompensation += excess * 10;
                company.materials = 20;
            }
            if (totalCompensation > 0) {
                company.cash += totalCompensation;
                alert(`不良在庫発生！20個超過分を処分\n保険金¥${totalCompensation}を受け取りました`);
            } else {
                alert('各置場の在庫が20個以下のため効果なし');
                rowUsed = false;
            }
            break;
        case 63: // 機械故障
        case 64:
            company.cash = Math.max(0, company.cash - 5);
            // 機械故障による追加固定費を記録
            if (!company.additionalFixedCost) {
                company.additionalFixedCost = 0;
            }
            company.additionalFixedCost += 5;
            alert('機械故障！\n製造経費▲5（現金から即時支払い）\n追加固定費+5（期末処理時に計上）');
            break;
    }
    
    closeModal();
    
    if (rowUsed) {
        endTurn();
    } else {
        nextTurn();
    }
}

// Special service modal
function showSpecialServiceModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">特別サービスを選択してください:</label>
            <div style="margin: 10px 0;">
                <button class="action-btn primary" onclick="executeMaterialPurchase()" style="width: 100%; margin: 5px 0;">
                    材料購入（1個¥10で5個まで）
                </button>
                <button class="action-btn secondary" onclick="executeAdPurchase()" style="width: 100%; margin: 5px 0;">
                    広告チップ購入（1枚¥20で2枚まで）
                </button>
            </div>
        </div>
    `;
    
    showModal('特別サービス', content);
}

// Execute material purchase from special service
function executeMaterialPurchase() {
    const company = gameState.companies[0];
    
    // 購入数量を選択させる
    const content = `
        <div class="form-group">
            <label class="form-label">材料購入：数量を選択してください</label>
            <p style="font-size: 12px; color: #666;">特別価格：1個10円（最大5個まで）</p>
            <p style="font-size: 12px; color: #666;">現在の現金: ¥${company.cash}</p>
            <p style="font-size: 12px; color: #666;">現在の材料: ${company.materials}個</p>
            <select id="materialQty" class="form-control">
                <option value="0">購入しない</option>
                ${company.cash >= 10 ? '<option value="1">1個（¥10）</option>' : ''}
                ${company.cash >= 20 ? '<option value="2">2個（¥20）</option>' : ''}
                ${company.cash >= 30 ? '<option value="3">3個（¥30）</option>' : ''}
                ${company.cash >= 40 ? '<option value="4">4個（¥40）</option>' : ''}
                ${company.cash >= 50 ? '<option value="5">5個（¥50）</option>' : ''}
            </select>
            <button class="submit-btn" onclick="confirmMaterialPurchase()" style="margin-top: 10px;">購入</button>
        </div>
    `;
    
    showModal('特別サービス - 材料購入', content);
}

// Confirm material purchase from special service
function confirmMaterialPurchase() {
    const company = gameState.companies[0];
    const buyQty = parseInt(document.getElementById('materialQty').value || 0);
    
    if (buyQty > 0) {
        const cost = buyQty * 10;
        company.cash -= cost;
        company.materials += buyQty;
        company.totalMaterialCost += cost;
        incrementRow(gameState.companies.indexOf(company));
        closeModal();
        alert(`特別サービス：材料${buyQty}個を¥${cost}で購入しました`);
        updateDisplay();
        nextTurn();
    } else {
        closeModal();
        nextTurn();
    }
}

// Execute ad chip purchase from special service
function executeAdPurchase() {
    const company = gameState.companies[0];
    
    // 購入数量を選択させる
    const content = `
        <div class="form-group">
            <label class="form-label">広告チップ購入：数量を選択してください</label>
            <p style="font-size: 12px; color: #666;">特別価格：1枚20円（最大2枚まで）</p>
            <p style="font-size: 12px; color: #666;">現在の現金: ¥${company.cash}</p>
            <p style="font-size: 12px; color: #666;">現在の広告チップ: ${company.chips.advertising || 0}枚</p>
            <select id="adChipQty" class="form-control">
                <option value="0">購入しない</option>
                ${company.cash >= 20 ? '<option value="1">1枚（¥20）</option>' : ''}
                ${company.cash >= 40 ? '<option value="2">2枚（¥40）</option>' : ''}
            </select>
            <button class="submit-btn" onclick="confirmAdPurchase()" style="margin-top: 10px;">購入</button>
        </div>
    `;
    
    showModal('特別サービス - 広告チップ購入', content);
}

// Confirm ad chip purchase from special service
function confirmAdPurchase() {
    const company = gameState.companies[0];
    const buyQty = parseInt(document.getElementById('adChipQty').value || 0);
    
    if (buyQty > 0) {
        const cost = buyQty * 20;
        company.cash -= cost;
        company.chips.advertising = (company.chips.advertising || 0) + buyQty;
        incrementRow(gameState.companies.indexOf(company));
        closeModal();
        alert(`特別サービス：広告チップ${buyQty}枚を¥${cost}で購入しました`);
        updateDisplay();
        nextTurn();
    } else {
        closeModal();
        nextTurn();
    }
}

// Show forced action modal for 消費者運動発生
function showForcedActionModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">消費者運動発生：販売禁止のため、以下から選択してください</label>
            <div style="margin: 10px 0;">
                <button class="action-btn primary" onclick="closeModal(); showMaterialPurchaseModal();" style="width: 100%; margin: 5px 0;">
                    材料購入
                </button>
                <button class="action-btn primary" onclick="closeModal(); showProductionModal();" style="width: 100%; margin: 5px 0;">
                    完成・投入
                </button>
                <button class="action-btn secondary" onclick="closeModal(); doNothing();" style="width: 100%; margin: 5px 0;">
                    Do Nothing（1行消費）
                </button>
            </div>
        </div>
    `;
    
    showModal('消費者運動発生 - 行動選択', content);
}

// Show hiring choice modal for 縁故採用
function showHiringChoiceModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">縁故採用：追加する人員を選択してください</label>
            <p style="font-size: 12px; color: #666;">本社経費5円を支払い、固定費に5円追加されました</p>
            <div style="margin: 10px 0;">
                <button class="action-btn primary" onclick="executeHiring('worker')" style="width: 100%; margin: 5px 0;">
                    ワーカーを1名追加
                </button>
                <button class="action-btn secondary" onclick="executeHiring('salesman')" style="width: 100%; margin: 5px 0;">
                    セールスマンを1名追加
                </button>
            </div>
        </div>
    `;
    
    showModal('縁故採用', content);
}

// Execute hiring from 縁故採用
function executeHiring(type) {
    const company = gameState.companies[0];
    
    if (type === 'worker') {
        company.workers++;
        closeModal();
        alert('縁故採用：ワーカーを1名追加しました');
    } else if (type === 'salesman') {
        company.salesmen++;
        closeModal();
        alert('縁故採用：セールスマンを1名追加しました');
    }
    
    updateDisplay();
    nextTurn();
}

// Execute common purchase for all companies (各社共通)
function executeAllCompaniesCommonPurchase() {
    const triggerCompany = gameState.companies[gameState.currentPlayerIndex];
    const content = `
        <div class="risk-display">
            <div class="risk-title">${triggerCompany.name}が「各社共通」を引きました</div>
            <div class="risk-description">全社が12円で3個まで材料を購入できます<br>（まず市場から、不足分は海外から）</div>
        </div>
        <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">あなたの購入数量:</label>
            <p>現在の現金: ¥${gameState.companies[0].cash}</p>
            <select id="playerQuantity" class="form-control">
                <option value="0">購入しない</option>
                <option value="1">1個（¥12）</option>
                <option value="2">2個（¥24）</option>
                <option value="3">3個（¥36）</option>
            </select>
        </div>
        <button class="submit-btn" onclick="processCommonPurchase()">決定</button>
    `;
    
    showModal('各社共通購入', content);
}

// Process common purchase
function processCommonPurchase() {
    const playerQty = parseInt(document.getElementById('playerQuantity').value || 0);
    let purchaseLog = [];
    
    // プレイヤーの購入処理
    if (playerQty > 0) {
        const playerCompany = gameState.companies[0];
        const cost = playerQty * 12;
        
        if (playerCompany.cash >= cost) {
            let purchased = 0;
            
            // まず市場から購入
            for (const market of gameState.markets) {
                if (purchased >= playerQty) break;
                if (market.currentStock > 0) {
                    const qty = Math.min(playerQty - purchased, market.currentStock);
                    market.currentStock -= qty;
                    purchased += qty;
                }
            }
            
            // 不足分は海外市場（ストッカー）から
            const overseasMarket = gameState.markets.find(m => m.name === '海外');
            if (purchased < playerQty && overseasMarket) {
                const qty = playerQty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - qty);
                purchased += qty;
            }
            
            playerCompany.cash -= cost;
            playerCompany.materials += playerQty;
            playerCompany.totalMaterialCost += cost;
            playerCompany.rowsUsed++;
            
            purchaseLog.push(`あなた: ${playerQty}個購入（¥${cost}）`);
        } else {
            purchaseLog.push('あなた: 現金不足で購入できず');
        }
    } else {
        purchaseLog.push('あなた: 購入しない');
    }
    
    // AI会社の購入処理
    for (let i = 1; i < gameState.companies.length; i++) {
        const company = gameState.companies[i];
        const availableMarkets = gameState.markets.filter(m => m.currentStock > 0);
        
        if (availableMarkets.length > 0) {
            // AIは1-3個をランダムに決定
            let aiQty = Math.floor(Math.random() * 4); // 0-3個
            
            // 保守的な会社は少なめに購入
            if (company.strategy === 'conservative') {
                aiQty = Math.min(aiQty, 2);
            }
            // 積極的な会社は多めに購入
            if (company.strategy === 'aggressive') {
                aiQty = Math.max(2, aiQty);
            }
            
            if (aiQty > 0 && company.cash >= aiQty * 12) {
                // ランダムに市場を選択
                const market = availableMarkets[Math.floor(Math.random() * availableMarkets.length)];
                const actualQty = Math.min(aiQty, market.currentStock);
                
                company.cash -= actualQty * 12;
                company.materials += actualQty;
                company.totalMaterialCost += actualQty * 12;
                market.currentStock -= actualQty;
                
                purchaseLog.push(`${company.name}: ${market.name}から${actualQty}個購入`);
            }
        }
    }
    
    closeModal();
    updateDisplay();
    
    // 購入結果を表示
    if (purchaseLog.length > 0) {
        alert('【各社共通購入結果】\n' + purchaseLog.join('\n'));
    } else {
        alert('どの会社も購入しませんでした');
    }
    
    nextTurn();
}

// Render markets
function renderMarkets() {
    const container = document.getElementById('marketsContainer');
    let html = '';
    
    gameState.markets.forEach(market => {
        html += `
            <div class="market-card">
                <div class="market-header">
                    <span class="market-name">${market.name}</span>
                    <div class="market-prices">
                        <span class="price-tag buy">買¥${market.buyPrice}</span>
                        <span class="price-tag sell">売¥${market.sellPrice}</span>
                    </div>
                </div>
                <div class="market-stock-info">
                    <div class="market-stock">
                        ${Array(Math.min(market.currentStock, 20)).fill('<div class="stock-block"></div>').join('')}
                        ${market.currentStock > 20 ? '...' : ''}
                    </div>
                    <span class="stock-count">${market.currentStock}/${market.maxStock}</span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render companies
function renderCompanies() {
    const container = document.getElementById('companiesContainer');
    let html = '';
    
    gameState.companies.forEach((company, index) => {
        const isCurrentTurn = index === gameState.currentPlayerIndex;
        const isPlayer = company.type === 'player';
        const mfgCapacity = getManufacturingCapacity(company);
        const salesCapacity = getSalesCapacity(company);
        
        // Machine display
        let machineDisplay = '';
        company.machines.forEach((machine) => {
            const machineName = machine.type === 'small' ? 
                (machine.attachments > 0 ? '小型+A' : '小型') : '大型';
            machineDisplay += `<span class="machine-item">${machineName}</span>`;
        });
        
        // Warehouse display
        let warehouseDisplay = '';
        if (company.warehouses > 0) {
            warehouseDisplay = `<span class="warehouse-item">倉庫${company.warehouses}(${company.warehouseLocation === 'materials' ? '材' : '製'})</span>`;
        }
        
        html += `
            <div class="company-card ${isPlayer ? 'player' : ''} ${isCurrentTurn ? 'current-turn' : ''}">
                <div class="company-header">
                    <span class="company-name">${company.name}</span>
                    <span class="company-cash">¥${company.cash}</span>
                    <span style="font-size: 11px; color: #666;">行:${company.currentRow || 1}/${gameState.maxRows}</span>
                </div>
                <div class="company-stats">
                    <div class="stat-item">自己資本: ¥${company.equity}</div>
                    <div class="stat-item">借入: ¥${company.loans + company.shortLoans}</div>
                    <div class="stat-item capacity" onclick="showManufacturingCapacityDetail(${index})" style="cursor: pointer;">製造能力: ${mfgCapacity}</div>
                    <div class="stat-item capacity" onclick="showSalesCapacityDetail(${index})" style="cursor: pointer;">販売能力: ${salesCapacity}</div>
                </div>
                <div class="machine-section">
                    ${machineDisplay || '<span class="machine-item">機械なし</span>'}
                </div>
                ${warehouseDisplay ? `<div class="warehouse-section">${warehouseDisplay}</div>` : ''}
                <div class="personnel-section">
                    <div class="personnel-group">
                        <span class="personnel-label">ワーカー:</span>
                        <div class="personnel-dots">
                            ${Array(company.workers).fill('<div class="personnel-dot"></div>').join('')}
                        </div>
                        <span>(${company.workers})</span>
                    </div>
                    <div class="personnel-group">
                        <span class="personnel-label">セールス:</span>
                        <div class="personnel-dots">
                            ${Array(company.salesmen).fill('<div class="personnel-dot"></div>').join('')}
                        </div>
                        <span>(${company.salesmen})</span>
                    </div>
                </div>
                <div class="inventory-section">
                    <div class="inventory-box">
                        <div class="inventory-label">材料</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.materials, 10)).fill('<div class="inventory-block material"></div>').join('')}
                            ${company.materials > 10 ? `<small>+${company.materials - 10}</small>` : ''}
                        </div>
                    </div>
                    <div class="inventory-box">
                        <div class="inventory-label">仕掛品</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.wip, 10)).fill('<div class="inventory-block wip"></div>').join('')}
                            ${company.wip > 10 ? `<small>+${company.wip - 10}</small>` : ''}
                        </div>
                    </div>
                    <div class="inventory-box">
                        <div class="inventory-label">製品</div>
                        <div class="inventory-blocks">
                            ${Array(Math.min(company.products, 10)).fill('<div class="inventory-block product"></div>').join('')}
                            ${company.products > 10 ? `<small>+${company.products - 10}</small>` : ''}
                        </div>
                    </div>
                </div>
                <div class="chips-section">
                    <div class="chip-row">
                        <span class="chip-label">コンピュータ:</span>
                        <div class="chip-dots">
                            ${Array(3).fill(0).map((_, i) => 
                                `<div class="chip-dot ${i < company.chips.computer ? 'filled computer' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">保険:</span>
                        <div class="chip-dots">
                            ${Array(3).fill(0).map((_, i) => 
                                `<div class="chip-dot ${i < company.chips.insurance ? 'filled insurance' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">研究:</span>
                        <div class="chip-dots">
                            ${Array(5).fill(0).map((_, i) => 
                                `<div class="chip-dot ${i < (company.chips.research + company.nextPeriodChips.research) ? 'filled research' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">教育:</span>
                        <div class="chip-dots">
                            ${Array(gameState.currentPeriod === 2 ? 2 : 1).fill(0).map((_, i) => 
                                `<div class="chip-dot ${i < (company.chips.education + company.nextPeriodChips.education) ? 'filled education' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chip-row">
                        <span class="chip-label">広告:</span>
                        <div class="chip-dots">
                            ${Array(5).fill(0).map((_, i) => 
                                `<div class="chip-dot ${i < (company.chips.advertising + company.nextPeriodChips.advertising) ? 'filled advertising' : ''}"></div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Render action buttons
function renderActionButtons() {
    const container = document.getElementById('actionButtons');
    const isPlayerTurn = gameState.currentPlayerIndex === 0;
    
    let html = '';
    
    if (!gameState.periodStarted) {
        html = `<button class="action-btn warning" onclick="startPeriod()">第${gameState.currentPeriod}期を開始</button>`;
    } else if (isPlayerTurn) {
        html = `
            <button class="action-btn main mobile-card-btn" onclick="showTurnStartOptions()">カードを引く</button>
        `;
    } else {
        html = `
            <button class="action-btn secondary" disabled>AIのターン中...</button>
        `;
    }
    
    container.innerHTML = html;
}

// Update display
function updateDisplay() {
    const player = gameState.companies[0];
    
    document.getElementById('currentPeriod').textContent = gameState.currentPeriod;
    // 現在のプレイヤーの行数を表示
    const currentCompany = gameState.companies[gameState.currentPlayerIndex];
    document.getElementById('currentRow').textContent = `${currentCompany.currentRow || 1}/${gameState.maxRows}`;
    document.getElementById('currentPlayer').textContent = currentCompany.name;
    document.getElementById('equity').textContent = `¥${player.equity}`;
    document.getElementById('periodPayment').textContent = `¥${calculatePeriodPayment(player)}`;
    document.getElementById('fixedCost').textContent = `¥${calculateFixedCost(player)}`;
    
    renderMarkets();
    renderCompanies();
    renderActionButtons();
}

// Modal functions
function showModal(title, content) {
    const modalHtml = `
        <div class="modal active">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">${title}</h3>
                    <button class="close-btn" onclick="closeModal(true)">戻る</button>
                </div>
                ${content}
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modalHtml;
}

function closeModal(returnToDecision = false) {
    document.getElementById('modalContainer').innerHTML = '';
    // 意思決定カードから来た場合は意思決定カードに戻る
    if (returnToDecision && gameState.currentPlayerIndex === 0) {
        showDecisionCard();
    }
}

// Buy materials modal
function showBuyMaterialsModal() {
    const company = gameState.companies[0];
    const period = gameState.currentPeriod;
    const mfgCapacity = getManufacturingCapacity(company);
    
    // 購入制限チェック
    let maxPurchase = 999;
    
    if (period === 2 && gameState.currentRow === 2) {
        // 2期2行目（期首処理後すぐ）のみ3個制限
        maxPurchase = 3;
    } else if (period === 2 && gameState.currentRow >= 3) {
        // 2期3行目以降は制限なし
        maxPurchase = 999;
    } else if (period >= 3) {
        // 3期以降は製造能力まで
        maxPurchase = mfgCapacity;
    }
    
    const content = `
        <div class="form-group">
            <label class="form-label">購入する市場を選択:</label>
            <select id="marketSelect" class="form-control">
                ${gameState.markets.map((m, i) => 
                    `<option value="${i}">${m.name} (¥${m.buyPrice}/個, 在庫: ${m.currentStock})</option>`
                ).join('')}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">購入数量（制限: ${maxPurchase}個）:</label>
            <select id="quantity" class="form-control">
                ${Array(Math.min(maxPurchase, 10)).fill(0).map((_, i) => 
                    `<option value="${i+1}">${i+1}個</option>`
                ).join('')}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">必要金額: <span id="totalCost">¥0</span></label>
        </div>
        <button class="submit-btn" onclick="buyMaterials()">購入</button>
    `;
    
    showModal('材料購入', content);
    
    // Update cost display
    const updateCost = () => {
        const marketIndex = document.getElementById('marketSelect').value;
        const quantity = parseInt(document.getElementById('quantity').value) || 0;
        const market = gameState.markets[marketIndex];
        const cost = market.buyPrice * quantity;
        document.getElementById('totalCost').textContent = `¥${cost}`;
    };
    
    document.getElementById('marketSelect').addEventListener('change', updateCost);
    document.getElementById('quantity').addEventListener('change', updateCost);
    updateCost();
}

// Update material purchase cost (for multiple markets - not used now)
function updateMaterialCost() {
    let totalCost = 0;
    let rowsUsed = 0;
    
    gameState.markets.forEach((market, i) => {
        const qty = parseInt(document.getElementById(`market_${i}`).value || 0);
        if (qty > 0) {
            totalCost += market.buyPrice * qty;
            rowsUsed++;
        }
    });
    
    document.getElementById('totalCost').textContent = `¥${totalCost}`;
    document.getElementById('rowsUsed').textContent = rowsUsed;
}

// Buy materials from multiple markets
function buyMaterialsFromMultiple() {
    const company = gameState.companies[0];
    let totalCost = 0;
    let totalQty = 0;
    let rowsUsed = 0;
    let purchases = [];
    
    // 各市場からの購入を収集
    gameState.markets.forEach((market, i) => {
        const qty = parseInt(document.getElementById(`market_${i}`).value || 0);
        if (qty > 0) {
            totalCost += market.buyPrice * qty;
            totalQty += qty;
            rowsUsed++;
            purchases.push({market: market, qty: qty, cost: market.buyPrice * qty});
        }
    });
    
    if (rowsUsed === 0) {
        alert('購入する市場を選択してください');
        return;
    }
    
    // 倉庫容量チェック
    const newMaterialCount = company.materials + totalQty;
    if (newMaterialCount > 10 && company.warehouses === 0) {
        alert(`材料置場に10個以上置くには無災害倉庫が必要です。\n現在: ${company.materials}個、購入後: ${newMaterialCount}個`);
        return;
    }
    if (company.warehouses > 0 && company.warehouseLocation === 'materials' && newMaterialCount > 12 * company.warehouses) {
        alert(`無災害倉庫の容量を超えます。\n倉庫${company.warehouses}台で最大${12 * company.warehouses}個まで`);
        return;
    }
    
    // 行数チェック
    if (gameState.currentRow + rowsUsed - 1 > gameState.maxRows) {
        alert(`行数が不足しています（必要: ${rowsUsed}行、残り: ${gameState.maxRows - gameState.currentRow + 1}行）`);
        return;
    }
    
    // 現金チェックと短期借入
    if (company.cash < totalCost) {
        const needed = Math.ceil((totalCost - company.cash) / 0.6 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.6;
        alert(`現金不足のため短期借入¥${needed}を実行しました`);
    }
    
    // 購入実行
    company.cash -= totalCost;
    company.materials += totalQty;
    company.totalMaterialCost += totalCost;
    
    // 各市場の在庫を減らす
    purchases.forEach(p => {
        const marketIndex = gameState.markets.indexOf(p.market);
        gameState.markets[marketIndex].currentStock -= p.qty;
    });
    
    // 使用行数分進める
    gameState.currentRow += rowsUsed - 1; // -1は通常のendTurnで1行進むため
    
    closeModal();
    updateDisplay();
    
    // 購入結果を表示
    let message = `材料${totalQty}個を¥${totalCost}で購入しました\n`;
    purchases.forEach(p => {
        message += `${p.market.name}: ${p.qty}個 (¥${p.cost})\n`;
    });
    message += `${rowsUsed}行使用しました`;
    alert(message);
    
    endTurn();
}

// Buy materials (single market - legacy support)
function buyMaterials() {
    const company = gameState.companies[0];
    const marketIndex = parseInt(document.getElementById('marketSelect').value);
    const quantity = parseInt(document.getElementById('quantity').value);
    const market = gameState.markets[marketIndex];
    
    // Check warehouse capacity
    const newMaterialCount = company.materials + quantity;
    if (newMaterialCount > 10 && company.warehouses === 0) {
        alert(`材料置場に10個以上置くには無災害倉庫が必要です。\n現在: ${company.materials}個、購入後: ${newMaterialCount}個`);
        return;
    }
    if (company.warehouses > 0 && company.warehouseLocation === 'materials' && newMaterialCount > 12 * company.warehouses) {
        alert(`無災害倉庫の容量を超えます。\n倉庫${company.warehouses}台で最大${12 * company.warehouses}個まで`);
        return;
    }
    
    const cost = market.buyPrice * quantity;
    
    if (company.cash < cost) {
        // 短期借入
        const needed = Math.ceil((cost - company.cash) / 0.6 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.6;
        alert(`現金不足のため短期借入¥${needed}を実行しました`);
    }
    
    if (quantity > market.currentStock) {
        alert('在庫が不足しています！');
        return;
    }
    
    company.cash -= cost;
    company.materials += quantity;
    company.totalMaterialCost += cost;
    market.currentStock -= quantity;
    
    closeModal();
    updateDisplay();
    alert(`${market.name}から材料${quantity}個を¥${cost}で購入しました`);
    endTurn();
}

// Production modal
function showProductionModal() {
    const company = gameState.companies[0];
    
    // 労災発生チェック
    if (company.cannotProduce) {
        alert('労災発生中のため生産できません！');
        company.cannotProduce = false; // フラグをリセット
        showDecisionCard();
        return;
    }
    
    const mfgCapacity = getManufacturingCapacity(company);
    
    const content = `
        <div class="form-group">
            <label class="form-label">生産可能数: 最大${mfgCapacity}個</label>
            <label class="form-label">材料在庫: ${company.materials}個</label>
            <label class="form-label">仕掛品在庫: ${company.wip}個</label>
        </div>
        <div class="form-group">
            <label class="form-label">材料→仕掛品（¥1/個）:</label>
            <select id="matToWip" class="form-control">
                ${Array(Math.min(mfgCapacity, company.materials) + 1).fill(0).map((_, i) => 
                    `<option value="${i}" ${i === Math.min(mfgCapacity, company.materials) ? 'selected' : ''}>${i}個</option>`
                ).join('')}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">仕掛品→製品（¥1/個）:</label>
            <select id="wipToProd" class="form-control">
                ${Array(Math.min(mfgCapacity, company.wip) + 1).fill(0).map((_, i) => 
                    `<option value="${i}" ${i === Math.min(mfgCapacity, company.wip) ? 'selected' : ''}>${i}個</option>`
                ).join('')}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">生産コスト: <span id="totalCost">¥0</span></label>
        </div>
        <button class="submit-btn" onclick="produce()">生産</button>
    `;
    
    showModal('完成・投入', content);
    
    // Update cost display
    const updateCost = () => {
        const matToWip = parseInt(document.getElementById('matToWip').value) || 0;
        const wipToProd = parseInt(document.getElementById('wipToProd').value) || 0;
        const cost = matToWip + wipToProd;
        document.getElementById('totalCost').textContent = `¥${cost}`;
    };
    
    // Set initial cost display
    updateCost();
    
    document.getElementById('matToWip').addEventListener('change', updateCost);
    document.getElementById('wipToProd').addEventListener('change', updateCost);
    updateCost();
}

// Production
function produce() {
    const company = gameState.companies[0];
    const matToWip = parseInt(document.getElementById('matToWip').value);
    const wipToProd = parseInt(document.getElementById('wipToProd').value);
    
    // Check capacity limits
    const newWip = company.wip + matToWip - wipToProd;
    const newProducts = company.products + wipToProd;
    
    if (newWip > 10) {
        alert('仕掛品置場の容量不足です。仕掛品は10個までです。');
        return;
    }
    
    if (newProducts > 10 && company.warehouses === 0) {
        alert(`製品置場に10個以上置くには無災害倉庫が必要です。\n現在: ${company.products}個、生産後: ${newProducts}個`);
        return;
    }
    if (company.warehouses > 0 && company.warehouseLocation === 'products' && newProducts > 12 * company.warehouses) {
        alert(`無災害倉庫の容量を超えます。\n倉庫${company.warehouses}台で最大${12 * company.warehouses}個まで`);
        return;
    }
    
    const cost = matToWip + wipToProd;
    
    if (company.cash < cost) {
        // 短期借入
        const needed = Math.ceil((cost - company.cash) / 0.6 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.6;
        alert(`現金不足のため短期借入¥${needed}を実行しました`);
    }
    
    company.cash -= cost;
    company.materials -= matToWip;
    company.wip = newWip;
    company.products = newProducts;
    company.totalProductionCost += cost;
    
    closeModal();
    updateDisplay();
    alert(`材料${matToWip}個→仕掛品、仕掛品${wipToProd}個→製品を生産しました（¥${cost}）`);
    endTurn();
}

// Sales modal
function showSalesModal() {
    const company = gameState.companies[0];
    const salesCapacity = getSalesCapacity(company);
    const period = gameState.currentPeriod;
    
    // 2期は海外販売禁止
    const availableMarkets = period === 2 ? 
        gameState.markets.filter(m => m.name !== '海外') : 
        gameState.markets;
    
    // 最初の市場の情報を取得
    const firstMarket = availableMarkets[0];
    const firstMarketIndex = gameState.markets.indexOf(firstMarket);
    const maxQuantity = Math.min(salesCapacity, company.products);
    const defaultPrice = firstMarket.sellPrice - 4; // 最大価格-4円
    
    const content = `
        <div class="form-group">
            <label class="form-label">販売可能数: 最大${salesCapacity}個</label>
            <label class="form-label">製品在庫: ${company.products}個</label>
        </div>
        <div class="form-group">
            <label class="form-label">販売する市場を選択:</label>
            <select id="marketSelect" class="form-control">
                ${availableMarkets.map((m, i) => 
                    `<option value="${gameState.markets.indexOf(m)}">${m.name} (上限¥${m.sellPrice})</option>`
                ).join('')}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">販売数量:</label>
            <select id="quantity" class="form-control">
                ${Array(maxQuantity).fill(0).map((_, i) => 
                    `<option value="${i+1}" ${i+1 === maxQuantity ? 'selected' : ''}>${i+1}個</option>`
                ).join('')}
            </select>
        </div>
        <div class="form-group" id="bidPriceGroup">
            <label class="form-label">入札価格（1個あたり）:</label>
            <input type="number" id="bidPrice" class="form-control" min="1" max="${firstMarket.sellPrice}" value="${defaultPrice}">
        </div>
        <button class="submit-btn" onclick="processSale()">販売</button>
    `;
    
    showModal('商品販売', content);
    
    // 初期表示時に入札価格入力の表示/非表示を設定
    if (!firstMarket.needsBid) {
        document.getElementById('bidPriceGroup').style.display = 'none';
    }
    
    // 入札不要な市場の場合は価格入力を非表示、市場変更時に価格を更新
    document.getElementById('marketSelect').addEventListener('change', () => {
        const marketIndex = parseInt(document.getElementById('marketSelect').value);
        const market = gameState.markets[marketIndex];
        if (!market.needsBid) {
            document.getElementById('bidPriceGroup').style.display = 'none';
        } else {
            document.getElementById('bidPriceGroup').style.display = 'block';
            document.getElementById('bidPrice').max = market.sellPrice;
            document.getElementById('bidPrice').value = market.sellPrice - 4; // 市場変更時も最大価格-4円に設定
        }
    });
}

// Process sale
function processSale() {
    const company = gameState.companies[0];
    const marketIndex = parseInt(document.getElementById('marketSelect').value);
    const quantity = parseInt(document.getElementById('quantity').value);
    const market = gameState.markets[marketIndex];
    
    if (company.products < quantity) {
        alert('製品が不足しています！');
        return;
    }
    
    if (market.needsBid) {
        // 入札処理
        const bidPrice = parseInt(document.getElementById('bidPrice').value);
        
        // プレイヤーの入札（販売能力を超えて入札できない）
        const salesCapacity = getSalesCapacity(company);
        if (quantity > salesCapacity) {
            alert(`販売能力（${salesCapacity}個）を超えて入札できません`);
            return;
        }
        
        // Store bid for later processing
        // 価格競争力を計算（親ボーナス+研究チップ）
        const competitiveness = getPriceCompetitiveness(company, 0);  // 0はプレイヤーのindex
        const effectiveBidPrice = bidPrice - competitiveness;
        
        // デバッグ情報
        console.log(`プレイヤー入札: 表示価格=${bidPrice}, 競争力=${competitiveness}, 有効価格=${effectiveBidPrice}`);
        
        gameState.pendingBid = {
            market: marketIndex,
            company: 0,
            price: effectiveBidPrice,  // 有効入札価格
            quantity: quantity,
            displayPrice: bidPrice  // 表示用価格
        };
        
        // Show modal for other players to bid
        showOtherPlayersBidModal(market, marketIndex);
        return;  // Exit here, will continue after all bids collected
    } else {
        // 入札不要（大阪・東京・海外）
        const actualQty = Math.min(quantity, market.maxStock - market.currentStock);
        if (actualQty > 0) {
            company.cash += market.sellPrice * actualQty;
            company.products -= actualQty;
            company.totalSales += market.sellPrice * actualQty;
            company.totalSoldQuantity = (company.totalSoldQuantity || 0) + actualQty;
            market.currentStock += actualQty;
            
            closeModal();
            updateDisplay();
            alert(`${market.name}に製品${actualQty}個を¥${market.sellPrice * actualQty}で販売しました`);
            endTurn();
        }
    }
}

// Complete sale
function completeSale() {
    closeModal();
    updateDisplay();
    if (gameState.lastSaleInfo) {
        alert(gameState.lastSaleInfo);
        gameState.lastSaleInfo = null;
    }
    endTurn();
}

// Hire modal
function showHireModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">採用（最大3名まで、採用費¥5/人）:</label>
        </div>
        <div class="form-group">
            <label class="form-label">ワーカー数:</label>
            <select id="workerCount" class="form-control">
                <option value="0">0人</option>
                <option value="1">1人</option>
                <option value="2">2人</option>
                <option value="3">3人</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">セールスマン数:</label>
            <select id="salesmanCount" class="form-control">
                <option value="0">0人</option>
                <option value="1">1人</option>
                <option value="2">2人</option>
                <option value="3">3人</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">合計採用費: <span id="totalCost">¥0</span></label>
        </div>
        <button class="submit-btn" onclick="hire()">採用</button>
    `;
    
    showModal('採用', content);
    
    // Update cost display
    const updateCost = () => {
        const workers = parseInt(document.getElementById('workerCount').value) || 0;
        const salesmen = parseInt(document.getElementById('salesmanCount').value) || 0;
        const total = workers + salesmen;
        
        if (total > 3) {
            alert('合計3名までです');
            return;
        }
        
        const cost = total * 5;
        document.getElementById('totalCost').textContent = `¥${cost}`;
    };
    
    document.getElementById('workerCount').addEventListener('change', updateCost);
    document.getElementById('salesmanCount').addEventListener('change', updateCost);
    updateCost();
}

// Hire
function hire() {
    const company = gameState.companies[0];
    const workers = parseInt(document.getElementById('workerCount').value) || 0;
    const salesmen = parseInt(document.getElementById('salesmanCount').value) || 0;
    const total = workers + salesmen;
    
    if (total > 3) {
        alert('合計3名までです！');
        return;
    }
    
    const cost = total * 5;
    
    if (company.cash < cost) {
        // 短期借入
        const needed = Math.ceil((cost - company.cash) / 0.6 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.6;
        alert(`現金不足のため短期借入¥${needed}を実行しました`);
    }
    
    company.cash -= cost;
    company.workers += workers;
    company.salesmen += salesmen;
    
    // 教育チップの効果
    if (company.chips.education > 0) {
        company.workers++;
        company.salesmen++;
        alert('教育チップの効果でワーカー+1、セールス+1！');
    }
    
    closeModal();
    updateDisplay();
    alert(`ワーカー${workers}人、セールスマン${salesmen}人を採用しました（¥${cost}）`);
    endTurn();
}

// Machine modal
function showMachineModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">設備投資:</label>
            <select id="machineType" class="form-control">
                <option value="small">小型機械 (¥100, 製造能力1)</option>
                <option value="attachment">アタッチメント (¥30, 小型機械を能力2に)</option>
                <option value="large">大型機械 (¥200, 製造能力4)</option>
            </select>
        </div>
        <button class="submit-btn" onclick="buyMachine()">購入</button>
    `;
    
    showModal('設備投資', content);
}

// Buy machine
function buyMachine() {
    const company = gameState.companies[0];
    const type = document.getElementById('machineType').value;
    
    let cost = 0;
    if (type === 'small') cost = 100;
    else if (type === 'large') cost = 200;
    else if (type === 'attachment') cost = 30;
    
    if (company.cash < cost) {
        // 短期借入
        const needed = Math.ceil((cost - company.cash) / 0.6 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.6;
        alert(`現金不足のため短期借入¥${needed}を実行しました`);
    }
    
    if (type === 'attachment') {
        // Find small machine without attachment
        const smallMachine = company.machines.find(m => m.type === 'small' && m.attachments === 0);
        if (!smallMachine) {
            alert('アタッチメントを付けられる小型機械がありません！');
            return;
        }
        smallMachine.attachments = 1;
        company.cash -= cost;
        alert('小型機械にアタッチメントを追加しました');
    } else {
        company.cash -= cost;
        company.machines.push({type: type, attachments: 0});
        alert(`${type === 'small' ? '小型' : '大型'}機械を購入しました（¥${cost}）`);
    }
    
    closeModal();
    updateDisplay();
    endTurn();
}

// Warehouse modal (無災害倉庫)
function showWarehouseModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">無災害倉庫（¥20/個）:</label>
            <p style="font-size: 12px; color: #666;">効果：火災・盗難完全回避、材料・製品10個以上可能</p>
            <select id="warehouseCount" class="form-control">
                <option value="1">1個購入</option>
                <option value="2">2個購入</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">置場所:</label>
            <select id="warehouseLocation" class="form-control">
                <option value="materials">材料置場</option>
                <option value="products">製品置場</option>
            </select>
        </div>
        <button class="submit-btn" onclick="buyWarehouse()">購入</button>
    `;
    
    showModal('無災害倉庫購入', content);
}

// Buy warehouse
function buyWarehouse() {
    const company = gameState.companies[0];
    const count = parseInt(document.getElementById('warehouseCount').value);
    const location = document.getElementById('warehouseLocation').value;
    const cost = count * 20;
    
    if (company.cash < cost) {
        alert('現金が不足しています！');
        return;
    }
    
    company.cash -= cost;
    company.warehouses += count;
    company.warehouseLocation = location;
    
    closeModal();
    
    // カードを引く
    drawCard();
}

// Reassign modal (配置転換)
function showReassignModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">配置転換（¥5/人）:</label>
            <select id="reassignType" class="form-control">
                <option value="workerToSales">ワーカー→セールスマン</option>
                <option value="salesToWorker">セールスマン→ワーカー</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">人数:</label>
            <select id="reassignCount" class="form-control">
                <option value="1">1人</option>
                <option value="2">2人</option>
                <option value="3">3人</option>
            </select>
        </div>
        <button class="submit-btn" onclick="reassign()">配置転換</button>
    `;
    
    showModal('配置転換', content);
}

// Reassign
function reassign() {
    const company = gameState.companies[0];
    const type = document.getElementById('reassignType').value;
    const count = parseInt(document.getElementById('reassignCount').value);
    const cost = count * 5;
    
    if (company.cash < cost) {
        alert('現金が不足しています！');
        return;
    }
    
    if (type === 'workerToSales') {
        if (company.workers < count) {
            alert('ワーカーが不足しています！');
            return;
        }
        company.workers -= count;
        company.salesmen += count;
    } else {
        if (company.salesmen < count) {
            alert('セールスマンが不足しています！');
            return;
        }
        company.salesmen -= count;
        company.workers += count;
    }
    
    company.cash -= cost;
    
    closeModal();
    
    // カードを引く
    drawCard();
}

// Sell machine modal
function showSellMachineModal() {
    const company = gameState.companies[0];
    
    if (company.machines.length === 0) {
        alert('売却する機械がありません！');
        return;
    }
    
    const content = `
        <div class="form-group">
            <label class="form-label">売却する機械（簿価の70%）:</label>
            <select id="machineIndex" class="form-control">
                ${company.machines.map((m, i) => {
                    const name = m.type === 'small' ? 
                        (m.attachments > 0 ? '小型+アタッチメント' : '小型機械') : '大型機械';
                    const bookValue = m.type === 'small' ? 
                        (m.attachments > 0 ? 130 : 100) : 200;
                    const salePrice = Math.floor(bookValue * 0.7);
                    return `<option value="${i}">${name} (売却額: ¥${salePrice})</option>`;
                }).join('')}
            </select>
        </div>
        <button class="submit-btn" onclick="sellMachine()">売却</button>
    `;
    
    showModal('機械売却', content);
}

// Sell machine
function sellMachine() {
    const company = gameState.companies[0];
    const machineIndex = parseInt(document.getElementById('machineIndex').value);
    const machine = company.machines[machineIndex];
    
    const bookValue = machine.type === 'small' ? 
        (machine.attachments > 0 ? 130 : 100) : 200;
    const salePrice = Math.floor(bookValue * 0.7);
    const loss = bookValue - salePrice;
    
    company.cash += salePrice;
    company.machines.splice(machineIndex, 1);
    
    // 特別損失として期末に反映
    company.specialLoss = (company.specialLoss || 0) + loss;
    
    closeModal();
    alert(`機械を¥${salePrice}で売却しました（特別損失¥${loss}）`);
    
    // カードを引く
    drawCard();
}

// Chip purchase modal for decision cards
function showChipPurchaseModal() {
    const content = `
        <div class="form-group">
            <label class="form-label">戦略チップを選択：</label>
            <select id="chipType" class="form-control">
                <option value="research">研究開発チップ (¥20) - 価格競争力+2</option>
                <option value="education">教育チップ (¥20) - 製造・販売胾力+1</option>
                <option value="advertising">広告チップ (¥20) - 販売能力向上</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">購入数:</label>
            <select id="quantity" class="form-control">
                <option value="1">1個（戦略チップは1回1枚まで）</option>
            </select>
        </div>
        <button class="submit-btn" onclick="buyChipsFromDecision()">購入</button>
    `;
    
    showModal('戦略チップ購入', content);
}

// Buy chips from decision card
function buyChipsFromDecision() {
    const company = gameState.companies[0];
    const chipType = document.getElementById('chipType').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    
    const cost = quantity * 20;
    
    if (company.cash < cost) {
        alert('現金が不足しています');
        return;
    }
    
    // Check limits (2期は教育チップ2枚まで)
    const maxLimits = {
        research: 5, 
        education: gameState.currentPeriod === 2 ? 2 : 1,  // 2期は2枚まで
        advertising: 5
    };
    const currentCount = company.chips[chipType] || 0;
    const newTotal = currentCount + quantity;
    
    if (newTotal > maxLimits[chipType]) {
        alert(`${chipType}チップは最大${maxLimits[chipType]}枚までです`);
        return;
    }
    
    company.cash -= cost;
    company.chips[chipType] = newTotal;
    
    closeModal();
    alert(`${chipType}チップを${quantity}個購入しました（¥${cost}）`);
    
    endTurn();
}

// Show manufacturing capacity detail
function showManufacturingCapacityDetail(companyIndex) {
    const company = gameState.companies[companyIndex];
    let baseMachineCapacity = 0;
    let machineDetail = [];
    
    company.machines.forEach(machine => {
        if (machine.type === 'small') {
            const capacity = machine.attachments > 0 ? 2 : 1;
            baseMachineCapacity += capacity;
            machineDetail.push(`小型機械${machine.attachments > 0 ? '+アタッチメント' : ''}: ${capacity}`);
        } else if (machine.type === 'large') {
            baseMachineCapacity += 4;
            machineDetail.push(`大型機械: 4`);
        }
    });
    
    const computerBonus = company.chips.computer || 0;
    const machineCapacity = baseMachineCapacity + computerBonus;
    const workerCapacity = company.workers + (company.chips.education || 0);
    const finalCapacity = Math.min(machineCapacity, workerCapacity);
    
    const content = `
        <div class="breakdown-list">
            <h3>製造能力の詳細</h3>
            ${machineDetail.map(d => `<div class="breakdown-item"><span>${d}</span></div>`).join('')}
            ${computerBonus > 0 ? `<div class="breakdown-item"><span>コンピュータチップ: +${computerBonus}</span></div>` : ''}
            <div class="breakdown-item"><span>機械能力計: ${machineCapacity}</span></div>
            <hr>
            <div class="breakdown-item"><span>ワーカー: ${company.workers}</span></div>
            ${company.chips.education > 0 ? `<div class="breakdown-item"><span>教育チップ: +${company.chips.education}</span></div>` : ''}
            <div class="breakdown-item"><span>ワーカー能力計: ${workerCapacity}</span></div>
            <hr>
            <div class="breakdown-item breakdown-total"><span>製造能力</span><span>MIN(${machineCapacity}, ${workerCapacity}) = ${finalCapacity}</span></div>
        </div>
    `;
    
    showModal(`${company.name}の製造能力`, content);
}

// Show other players bid modal
function showOtherPlayersBidModal(market, marketIndex) {
    const content = `
        <div class="bid-display">
            <div class="bid-title">他社の入札参加</div>
            <p>市場: ${market.name} (最大価格: ¥${market.sellPrice})</p>
            <p>あなたの入札: ¥${gameState.pendingBid.displayPrice || gameState.pendingBid.price} × ${gameState.pendingBid.quantity}個</p>
            <p style="color: #666; font-size: 12px;">他社も入札に参加します（金額は非公開）</p>
            <button class="submit-btn" onclick="processBidsWithAllCompanies(${marketIndex})">入札結果を確認</button>
            <button class="cancel-btn" onclick="cancelPlayerBid()" style="margin-top: 10px;">入札に参加しない</button>
        </div>
    `;
    
    showModal('入札参加確認', content);
}

// Cancel player bid
function cancelPlayerBid() {
    // プレイヤーの入札をキャンセル
    gameState.pendingBid = null;
    closeModal();
    alert('入札への参加を取りやめました');
    endTurn();
}

// Process bids with all companies
function processBidsWithAllCompanies(marketIndex) {
    const market = gameState.markets[marketIndex];
    const allBids = [gameState.pendingBid];
    
    // AI companies also bid
    for (let i = 1; i < gameState.companies.length; i++) {
        const aiCompany = gameState.companies[i];
        if (aiCompany.products > 0) {
            const aiSalesCapacity = getSalesCapacity(aiCompany);
            const aiQuantity = Math.min(aiSalesCapacity, aiCompany.products);
            if (aiQuantity > 0) {
                // AIが親の場合、2円の価格競争力を追加
                const isAIParent = (gameState.currentPlayerIndex === i);
                const aiDisplayPrice = Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25));
                const aiPrice = aiDisplayPrice - getPriceCompetitiveness(aiCompany, isAIParent);
                allBids.push({
                    company: i, 
                    price: aiPrice, 
                    quantity: aiQuantity,
                    displayPrice: aiDisplayPrice
                });
            }
        }
    }
    
    // Sort by: 1) price (lowest), 2) research chips (most), 3) parent (priority)
    allBids.sort((a, b) => {
        // First compare actual bid price
        if (a.price !== b.price) return a.price - b.price;
        
        // Same price: compare research chips (more chips wins)
        const aResearch = gameState.companies[a.company].chips.research || 0;
        const bResearch = gameState.companies[b.company].chips.research || 0;
        if (aResearch !== bResearch) return bResearch - aResearch;
        
        // Same research chips: parent wins
        const aIsParent = (gameState.currentPlayerIndex === a.company);
        const bIsParent = (gameState.currentPlayerIndex === b.company);
        if (aIsParent && !bIsParent) return -1;
        if (!aIsParent && bIsParent) return 1;
        
        return 0;
    });
    
    // Show bid results with detailed calculation
    let bidResultHtml = '<div class="bid-display">';
    bidResultHtml += '<div class="bid-title">入札結果</div>';
    
    // 勝者の計算式を詳細表示
    const winner = allBids[0];
    const winnerCompany = gameState.companies[winner.company];
    const winnerResearch = winnerCompany.chips.research || 0;
    const winnerIsParent = (gameState.currentPlayerIndex === winner.company);
    
    bidResultHtml += '<div style="background: #d4edda; padding: 10px; margin: 10px 0; border-radius: 5px;">';
    bidResultHtml += `<strong>落札者: ${winnerCompany.name}</strong><br>`;
    bidResultHtml += `入札価格: ¥${winner.displayPrice || winner.price}/個 × ${winner.quantity}個<br>`;
    if (winnerResearch > 0 || winnerIsParent) {
        bidResultHtml += '<div style="font-size: 12px; margin-top: 5px;">【価格競争力】<br>';
        if (winnerResearch > 0) {
            bidResultHtml += `・研究チップ: ${winnerResearch}枚 × 2円 = ${winnerResearch * 2}円<br>`;
        }
        if (winnerIsParent) {
            bidResultHtml += `・親ボーナス: 2円<br>`;
        }
        const totalCompetitiveness = (winnerResearch * 2) + (winnerIsParent ? 2 : 0);
        bidResultHtml += `実質入札価格: ¥${(winner.displayPrice || winner.price) - totalCompetitiveness}/個で競争<br>`;
    }
    const saleAmount = (winner.displayPrice || winner.price) * winner.quantity;
    bidResultHtml += `</div><strong>売上金額: ¥${saleAmount}</strong>`;
    bidResultHtml += '</div>';
    
    // その他の入札者
    bidResultHtml += '<div class="bid-entries">';
    bidResultHtml += '<div style="font-size: 12px; color: #666; margin-bottom: 5px;">その他の入札:</div>';
    allBids.slice(1).forEach((bid) => {
        const bidCompany = gameState.companies[bid.company];
        const bidResearch = bidCompany.chips.research || 0;
        const bidIsParent = (gameState.currentPlayerIndex === bid.company);
        const competitiveness = (bidResearch * 2) + (bidIsParent ? 2 : 0);
        const effectivePrice = bid.price;
        const actualPrice = bid.displayPrice || bid.price;
        
        bidResultHtml += `
            <div class="bid-entry">
                <span>${bidCompany.name}</span>
                <span>¥${effectivePrice}（¥${actualPrice}）× ${bid.quantity}個</span>
            </div>
        `;
    });
    bidResultHtml += '</div></div>';
    
    closeModal();
    showModal('入札結果', bidResultHtml + '<button class="submit-btn" onclick="completeSale()">OK</button>');
    
    // Process winner's sale (winner already declared above)
    const winCompany = gameState.companies[winner.company];
    const actualQty = Math.min(winner.quantity, market.maxStock - market.currentStock);
    
    if (actualQty > 0) {
        const salePrice = winner.displayPrice || winner.price;
        winCompany.cash += salePrice * actualQty;
        winCompany.products -= actualQty;
        winCompany.totalSales += salePrice * actualQty;
        market.currentStock += actualQty;
        // 入札勝利時の計算式を詳細に表示
        const researchChips = winCompany.chips.research || 0;
        const isParent = (gameState.currentPlayerIndex === winner.company);
        let calcFormula = `入札価格: ¥${salePrice}/個`;
        if (researchChips > 0 || isParent) {
            calcFormula += `\n価格競争力: `;
            if (researchChips > 0) calcFormula += `研究${researchChips}枚×2円=${researchChips * 2}円`;
            if (isParent) calcFormula += `${researchChips > 0 ? ' + ' : ''}親ボーナス2円`;
            calcFormula += `\n実質価格: ¥${salePrice - (researchChips * 2) - (isParent ? 2 : 0)}/個で勝利`;
        }
        calcFormula += `\n売上: ¥${salePrice} × ${actualQty}個 = ¥${salePrice * actualQty}`;
        
        gameState.lastSaleInfo = `【入札結果】\n${winCompany.name}が${market.name}に落札\n${calcFormula}`;
    }
    
    // Clear pending bid
    gameState.pendingBid = null;
}

// Show financial summary with detailed calculations
function showFinancialSummary(financialData) {
    let html = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: left;">会社名</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">P<br>(単価)</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">V<br>(単価)</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">M<br>(単価)</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">Q<br>(合計)</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">PQ<br>(売上高)</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">VQ<br>(変動費)</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">MQ<br>(付加価値)</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">F<br>(固定費)</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">G<br>(利益)</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">詳細</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    financialData.forEach((data, index) => {
        const isPlayer = index === 0;
        const company = gameState.companies[index];
        html += `
            <tr style="background: ${isPlayer ? '#e7f3ff' : 'white'};">
                <td style="border: 1px solid #dee2e6; padding: 8px; font-weight: ${isPlayer ? 'bold' : 'normal'};">${data.name}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">${data.p.toFixed(1)}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">${data.v.toFixed(1)}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">${data.m.toFixed(1)}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right; font-weight: bold;">${data.q}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">¥${data.pq}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">¥${data.vq}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right; font-weight: bold;">¥${data.mq}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right;">¥${data.f}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: right; font-weight: bold; color: ${data.g >= 0 ? '#28a745' : '#dc3545'};">¥${data.g}</td>
                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">
                    <button onclick="showFinancialDetails(${index})" style="padding: 2px 8px; font-size: 11px; cursor: pointer;">🔍</button>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div style="margin-top: 10px; font-size: 11px; color: #666;">
            <p><strong>計算式の説明：</strong></p>
            <p>P = PQ ÷ Q（売上単価）、V = VQ ÷ Q（変動費単価）、M = MQ ÷ Q（付加価値単価）</p>
            <p>MQ = PQ - VQ（付加価値総額）、G = MQ - F（利益）</p>
        </div>
        <button class="submit-btn" onclick="closeModal(); proceedToNextPeriod();" style="margin-top: 15px;">次期へ進む</button>
    `;
    
    showModal(`第${gameState.currentPeriod}期 決算結果`, html);
}

// Show detailed financial calculations for a company
function showFinancialDetails(companyIndex) {
    const company = gameState.companies[companyIndex];
    const pq = company.totalSales;
    const vq = calculateVQ(company);
    const mq = pq - vq;
    const fixedCosts = calculateFixedCost(company);
    const g = mq - fixedCosts - (company.specialLoss || 0);
    
    // Q = 販売個数
    const q = company.totalSoldQuantity || 0;
    
    // 在庫数量
    const inventoryP = company.products || 0;
    const inventoryV = company.wip || 0;
    const inventoryM = company.materials || 0;
    
    // VQの詳細計算
    const materialCost = company.totalMaterialCost || 0;
    const productionCost = company.totalProductionCost || 0;
    const endInventoryValue = (inventoryM * 13) + (inventoryV * 14) + (inventoryP * 15);
    const startInventoryValue = (company.periodStartInventory.materials * 13) + 
                               (company.periodStartInventory.wip * 14) + 
                               (company.periodStartInventory.products * 15);
    
    let html = `
        <div class="breakdown-list" style="max-height: 500px; overflow-y: auto;">
            <h3>${company.name}の財務詳細</h3>
            
            <div class="breakdown-item breakdown-total"><span>【PQ：売上高】</span><span>¥${pq}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　期中売上累計</span><span>¥${pq}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【VQ：変動費総額】</span><span>¥${vq}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　①材料購入費</span><span>¥${materialCost}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　②完成投入費</span><span>¥${productionCost}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　③期末在庫評価額</span><span>¥${endInventoryValue}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #666;"><span>　　(材${inventoryM}×13 + 仕${inventoryV}×14 + 製${inventoryP}×15)</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　④期首在庫評価額</span><span>-¥${startInventoryValue}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #666;"><span>　　(材${company.periodStartInventory.materials}×13 + 仕${company.periodStartInventory.wip}×14 + 製${company.periodStartInventory.products}×15)</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #28a745;"><span>　VQ = ①+②+③-④</span><span>¥${vq}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【MQ：付加価値総額】</span><span>¥${mq}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #28a745;"><span>　MQ = PQ - VQ</span><span>¥${pq} - ¥${vq}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【F：固定費】</span><span>¥${fixedCosts}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　給料</span><span>¥${calculateSalaryCost(company, gameState.currentPeriod)}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　チップ費用</span><span>¥${calculateChipCost(company, gameState.currentPeriod)}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　減価償却費</span><span>¥${calculateDepreciation(company, gameState.currentPeriod)}</span></div>
            ${company.specialLoss ? `<div class="breakdown-item" style="font-size: 11px;"><span>　特別損失</span><span>¥${company.specialLoss}</span></div>` : ''}
            
            <div class="breakdown-item breakdown-total"><span>【G：利益】</span><span style="color: ${g >= 0 ? '#28a745' : '#dc3545'}">¥${g}</span></div>
            <div class="breakdown-item" style="font-size: 11px; color: #28a745;"><span>　G = MQ - F</span><span>¥${mq} - ¥${fixedCosts}</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【Q：販売個数】</span><span>${company.totalSoldQuantity || 0}個</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【期末在庫】</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　材料</span><span>${inventoryM}個</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　仕掛品</span><span>${inventoryV}個</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　製品</span><span>${inventoryP}個</span></div>
            
            <div class="breakdown-item breakdown-total"><span>【単価計算】</span><span></span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　P = PQ÷Q</span><span>¥${pq}÷${q} = ${q > 0 ? (pq/q).toFixed(1) : '―'}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　V = VQ÷Q</span><span>¥${vq}÷${q} = ${q > 0 ? (vq/q).toFixed(1) : '―'}</span></div>
            <div class="breakdown-item" style="font-size: 11px;"><span>　M = MQ÷Q</span><span>¥${mq}÷${q} = ${q > 0 ? (mq/q).toFixed(1) : '―'}</span></div>
        </div>
        <button class="submit-btn" onclick="closeModal();" style="margin-top: 10px;">閉じる</button>
    `;
    
    showModal(`${company.name}の財務詳細`, html);
}

// Store financial data for reference
window.lastFinancialData = [];

// Proceed to next period
function proceedToNextPeriod() {
    // Move to next period
    gameState.currentPeriod++;
    gameState.currentPlayerIndex = 0;
    // 2期は期首処理で1行目を使うので、1からスタート
    // 3-5期も期首処理があるので1からスタート
    gameState.currentRow = 1;
    gameState.periodStarted = false;
    gameState.doNothingCount = {};
    gameState.last5RowWarningShown = false;  // ラスト5行警告フラグをリセット
    
    // Set max rows based on period
    if (gameState.currentPeriod === 3) {
        gameState.maxRows = 30;
    } else if (gameState.currentPeriod === 4) {
        gameState.maxRows = 34;
    } else if (gameState.currentPeriod === 5) {
        gameState.maxRows = 35;
    }
    
    if (gameState.currentPeriod > 5) {
        endGame();
    } else {
        // Period 2: Auto-purchase chips and start from row 2
        if (gameState.currentPeriod === 2) {
            // 期首処理として1行目を消費し、2行目から開始
            gameState.maxRows = gameState.maxRowsByPeriod[2];  // 2期は20行
            gameState.currentRow = 2;  // 期首処理済みなので2行目から開始（廃止予定）
            
            // 期首に自動でコンピュータと保険を購入
            gameState.companies.forEach(company => {
                const computerCost = 20;
                const insuranceCost = 5;
                const totalCost = computerCost + insuranceCost;
                
                // 各社の行数を2に設定（期首処理で1行使用）
                company.currentRow = 2;
                
                if (company.cash >= totalCost) {
                    company.cash -= totalCost;
                    company.chips.computer = 1;  // 毎期1枚購入
                    company.chips.insurance = 1;
                } else {
                    // Apply short loan if needed
                    const needed = Math.ceil((totalCost - company.cash) / 0.6 / 50) * 50;
                    company.shortLoans += needed;
                    company.cash += needed * 0.6;
                    company.cash -= totalCost;
                    company.chips.computer = 1;
                    company.chips.insurance = 1;
                }
            });
            
            gameState.periodStarted = true;
            updateDisplay();
            alert(`第${gameState.currentPeriod}期を開始します\n全社：コンピュータチップ(¥20)と保険チップ(¥5)を自動購入しました。\n期首処理により2行目からゲーム開始です。`);
            
            // 強制的にもう一度updateDisplay()を呼んで確実に2行目表示
            setTimeout(() => {
                updateDisplay();
                showTurnStartOptions();
            }, 100);
        } else {
            // Periods 3-5: Ask about borrowing
            showBorrowingChoice();
        }
    }
}

// Show borrowing choice for periods 3-5
function showBorrowingChoice() {
    const content = `
        <div style="text-align: center; padding: 20px;">
            <h3>第${gameState.currentPeriod}期開始</h3>
            <p>借入を行いますか？</p>
            <button class="action-btn primary" onclick="startPeriodWithBorrowing()" style="margin: 10px;">借入を行う（3行目からスタート）</button>
            <button class="action-btn secondary" onclick="startPeriodWithoutBorrowing()" style="margin: 10px;">借入を行わない（2行目からスタート）</button>
        </div>
    `;
    
    showModal('期首処理', content);
}

// Start period with borrowing (periods 3-5)
function startPeriodWithBorrowing() {
    // Auto-purchase chips for all companies first
    gameState.companies.forEach(company => {
        const computerCost = 20;
        const insuranceCost = 5;
        const totalCost = computerCost + insuranceCost;
        
        // 期首処理で2行使用（借入あり）→3行目から開始
        company.currentRow = 3;
        
        if (company.cash >= totalCost) {
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        } else {
            // Apply short loan if needed
            const needed = Math.ceil((totalCost - company.cash) / 0.6 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.6;
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        }
    });
    
    gameState.currentRow = 3;  // Start from row 3 when borrowing
    // Set maxRows based on period
    if (gameState.currentPeriod === 3) {
        gameState.maxRows = gameState.maxRowsByPeriod[3];
    } else if (gameState.currentPeriod === 4) {
        gameState.maxRows = gameState.maxRowsByPeriod[4];
    } else if (gameState.currentPeriod === 5) {
        gameState.maxRows = gameState.maxRowsByPeriod[5];
    }
    gameState.periodStarted = true;
    closeModal();
    updateDisplay();
    alert(`第${gameState.currentPeriod}期を開始します\n全社：コンピュータチップ(¥20)と保険チップ(¥5)を自動購入しました。\n借入を実施するため、3行目からゲームスタートです。`);
    showBorrowModal();
}

// Start period without borrowing (periods 3-5)
function startPeriodWithoutBorrowing() {
    // Auto-purchase chips for all companies first
    gameState.companies.forEach(company => {
        const computerCost = 20;
        const insuranceCost = 5;
        const totalCost = computerCost + insuranceCost;
        
        // 期首処理で1行使用（借入なし）→2行目から開始
        company.currentRow = 2;
        
        if (company.cash >= totalCost) {
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        } else {
            // Apply short loan if needed
            const needed = Math.ceil((totalCost - company.cash) / 0.6 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.6;
            company.cash -= totalCost;
            company.chips.computer = 1;
            company.chips.insurance = 1;
        }
    });
    
    // Period 3-5: 借入なしの場合は2行目から開始
    gameState.currentRow = 2;  // Start from row 2 (period start processing uses 1 row)
    // Set maxRows based on period
    if (gameState.currentPeriod === 3) {
        gameState.maxRows = gameState.maxRowsByPeriod[3];
    } else if (gameState.currentPeriod === 4) {
        gameState.maxRows = gameState.maxRowsByPeriod[4];
    } else if (gameState.currentPeriod === 5) {
        gameState.maxRows = gameState.maxRowsByPeriod[5];
    }
    gameState.periodStarted = true;
    closeModal();
    updateDisplay();
    alert(`第${gameState.currentPeriod}期を開始します\n全社：コンピュータチップ(¥20)と保険チップ(¥5)を自動購入しました。\n期首処理完了で3行目からゲームスタートです。`);
    showTurnStartOptions();
}

// Show borrowing modal
function showBorrowModal() {
    const company = gameState.companies[0];
    const maxLoan = Math.round(company.equity * 0.5);
    
    const content = `
        <div class="form-group">
            <label class="form-label">長期借入（自己資本の0.5倍まで: ¥${maxLoan}）</label>
            <select id="loanAmount" class="form-control">
                <option value="0">借りない</option>
                <option value="50">¥50</option>
                <option value="100">¥100</option>
                ${maxLoan >= 150 ? '<option value="150">¥150</option>' : ''}
                ${maxLoan >= 200 ? '<option value="200">¥200</option>' : ''}
            </select>
        </div>
        <button class="submit-btn" onclick="processBorrowing()">借入を実施</button>
    `;
    
    showModal('借入処理', content);
}

// Process borrowing
function processBorrowing() {
    const company = gameState.companies[0];
    const loanAmount = parseInt(document.getElementById('loanAmount').value || 0);
    
    if (loanAmount > 0) {
        company.loans += loanAmount;
        company.cash += loanAmount;
        alert(`¥${loanAmount}を借入しました`);
    }
    
    closeModal();
    updateDisplay();
    showTurnStartOptions();
}

// Show sales capacity detail
function showSalesCapacityDetail(companyIndex) {
    const company = gameState.companies[companyIndex];
    const baseCapacity = company.salesmen * 2;
    const effectiveAds = Math.min(company.chips.advertising, company.salesmen * 2);
    const educationBonus = company.chips.education || 0;
    const totalCapacity = baseCapacity + effectiveAds + educationBonus;
    
    const content = `
        <div class="breakdown-list">
            <h3>販売能力の詳細</h3>
            <div class="breakdown-item"><span>セールスマン: ${company.salesmen}人 × 2 = ${baseCapacity}</span></div>
            ${effectiveAds > 0 ? `<div class="breakdown-item"><span>広告チップ: +${effectiveAds} (最大${company.salesmen * 2}枚まで有効)</span></div>` : ''}
            ${educationBonus > 0 ? `<div class="breakdown-item"><span>教育チップ: +${educationBonus}</span></div>` : ''}
            <hr>
            <div class="breakdown-item breakdown-total"><span>販売能力</span><span>${totalCapacity}</span></div>
        </div>
    `;
    
    showModal(`${company.name}の販売能力`, content);
}

// Show AI bid notification
function showAIBidNotification() {
    const bid = gameState.aiPendingBid;
    const playerCompany = gameState.companies[0];
    const playerSalesCapacity = getSalesCapacity(playerCompany);
    const playerMaxQty = Math.min(playerSalesCapacity, playerCompany.products);
    
    const content = `
        <div class="bid-display">
            <div class="bid-title">${gameState.companies[bid.company].name}が入札を開始</div>
            <p>市場: ${bid.market.name} (最大価格: ¥${bid.market.sellPrice})</p>
            <p>${gameState.companies[bid.company].name}の入札: 非公開 × ${bid.quantity}個</p>
            <hr>
            <p>あなたも入札に参加しますか？</p>
            <p>現在の在庫: ${playerCompany.products}個 (販売能力: ${playerSalesCapacity})</p>
            <div class="form-group">
                <label class="form-label">入札価格（¥）:</label>
                <input type="number" id="playerBidPrice" class="form-control" value="${Math.floor(bid.market.sellPrice * 0.9)}" min="1" max="${bid.market.sellPrice}">
            </div>
            <div class="form-group">
                <label class="form-label">入札数量:</label>
                <select id="playerBidQty" class="form-control">
                    ${Array(playerMaxQty + 1).fill(0).map((_, i) => 
                        `<option value="${i}" ${i === playerMaxQty ? 'selected' : ''}>${i}個</option>`
                    ).join('')}
                </select>
            </div>
            <button class="submit-btn" onclick="processAIBidWithPlayer()">入札に参加</button>
            <button class="cancel-btn" onclick="skipPlayerBid()">参加しない</button>
        </div>
    `;
    
    showModal('他社入札への参加', content);
}

// Process AI bid with player participation
function processAIBidWithPlayer() {
    const bid = gameState.aiPendingBid;
    const playerPrice = parseInt(document.getElementById('playerBidPrice').value);
    const playerQty = parseInt(document.getElementById('playerBidQty').value);
    
    const allBids = [];
    
    // AI company's bid
    const aiCompany = gameState.companies[bid.company];
    const aiCompetitiveness = getPriceCompetitiveness(aiCompany);
    allBids.push({
        company: bid.company,
        price: bid.price,  // 有効入札額（既に競争力を引いた値）
        displayPrice: bid.price + aiCompetitiveness,  // 実際の入金額
        quantity: bid.quantity,
        competitiveness: aiCompetitiveness
    });
    
    // Player's bid
    if (playerQty > 0) {
        const playerCompetitiveness = getPriceCompetitiveness(gameState.companies[0]);
        allBids.push({
            company: 0,
            price: playerPrice - playerCompetitiveness,  // 有効入札額
            displayPrice: playerPrice,  // 実際の入金額
            quantity: playerQty,
            competitiveness: playerCompetitiveness
        });
    }
    
    // Other AI companies' bids
    for (let i = 1; i < gameState.companies.length; i++) {
        if (i !== bid.company) {
            const otherCompany = gameState.companies[i];
            if (otherCompany.products > 0) {
                const otherCapacity = getSalesCapacity(otherCompany);
                const otherQty = Math.min(otherCapacity, otherCompany.products);
                if (otherQty > 0) {
                    const otherDisplayPrice = Math.floor(bid.market.sellPrice * (0.7 + Math.random() * 0.25));
                    const otherPrice = otherDisplayPrice - getPriceCompetitiveness(otherCompany);
                    allBids.push({company: i, price: otherPrice, quantity: otherQty, displayPrice: otherDisplayPrice});
                }
            }
        }
    }
    
    // Sort by: 1) price (lowest), 2) research chips (most), 3) parent (priority)
    allBids.sort((a, b) => {
        // First compare actual bid price
        if (a.price !== b.price) return a.price - b.price;
        
        // Same price: compare research chips (more chips wins)
        const aResearch = gameState.companies[a.company].chips.research || 0;
        const bResearch = gameState.companies[b.company].chips.research || 0;
        if (aResearch !== bResearch) return bResearch - aResearch;
        
        // Same research chips: parent wins
        const aIsParent = (gameState.currentPlayerIndex === a.company);
        const bIsParent = (gameState.currentPlayerIndex === b.company);
        if (aIsParent && !bIsParent) return -1;
        if (!aIsParent && bIsParent) return 1;
        
        return 0;
    });
    
    // Process winner
    const winner = allBids[0];
    const winCompany = gameState.companies[winner.company];
    const actualQty = Math.min(winner.quantity, bid.market.maxStock - bid.market.currentStock);
    
    if (actualQty > 0) {
        const salePrice = winner.displayPrice || winner.price;
        winCompany.cash += salePrice * actualQty;
        winCompany.products -= actualQty;
        winCompany.totalSales += salePrice * actualQty;
        winCompany.totalSoldQuantity = (winCompany.totalSoldQuantity || 0) + actualQty;
        bid.market.currentStock += actualQty;
    }
    
    // Show results
    let resultHtml = '<div class="bid-display"><div class="bid-title">入札結果</div><div class="bid-entries">';
    allBids.forEach((b, index) => {
        const isWinner = index === 0;
        const company = gameState.companies[b.company];
        const isParent = (gameState.currentPlayerIndex === b.company);
        const researchChips = company.chips.research || 0;
        
        // 競争力の内訳を表示
        let competitiveBonus = '';
        if (isParent) competitiveBonus += '親+2 ';
        if (researchChips > 0) competitiveBonus += `研究+${researchChips * 2} `;
        
        // 有効入札額と実際の入金額を表示
        const effectivePrice = b.price;
        const actualPrice = b.displayPrice || (b.price + getPriceCompetitiveness(company));
        
        resultHtml += `
            <div class="bid-entry ${isWinner ? 'bid-winner' : ''}">
                <span>${company.name}</span>
                <span>¥${effectivePrice}（¥${actualPrice}）× ${b.quantity}個 ${competitiveBonus}</span>
            </div>
        `;
    });
    resultHtml += '</div><p style="font-size: 12px; margin-top: 10px;">※有効入札額（実際の入金額）</p></div><button class="submit-btn" onclick="continueAITurn()">OK</button>';
    
    closeModal();
    showModal('入札結果', resultHtml);
}

// Skip player bid
function skipPlayerBid() {
    // プレイヤーの入札をスキップ（数量0で処理）
    document.getElementById('playerBidQty').value = '0';
    processAIBidWithPlayer(); // Process without player bid
}

// Continue AI turn after bid
function continueAITurn() {
    closeModal();
    const company = gameState.companies[gameState.aiPendingBid.company];
    incrementRow(gameState.companies.indexOf(company));
    gameState.aiPendingBid = null;
    nextTurn();
}

// Insurance purchase modal (B-rule)
function showInsurancePurchaseModal() {
    const company = gameState.companies[0];
    
    if (company.chips.insurance > 0) {
        alert('すでに保険に加入しています');
        return;
    }
    
    const content = `
        <div class="form-group">
            <label class="form-label">保険チップ購入</label>
            <p style="font-size: 12px; color: #666;">価格：¥5<br>効果：火災・盗難時に保険金受取（使用後消費）</p>
        </div>
        <button class="submit-btn" onclick="buyInsurance()">購入(¥5)</button>
    `;
    
    showModal('保険チップ購入', content);
}

// Buy insurance
function buyInsurance() {
    const company = gameState.companies[0];
    
    if (company.cash < 5) {
        alert('現金が不足しています');
        return;
    }
    
    company.cash -= 5;
    company.chips.insurance = 1;
    
    closeModal();
    alert('保険チップを購入しました（¥5）');
    
    // カードを引く
    drawCard();
}

// Chip modal (for period-specific purchases)
function showChipModal(specificType = null) {
    const period = gameState.currentPeriod;
    const company = gameState.companies[0];
    
    let content = '';
    
    if (period === 2) {
        // 2期：その期に使用（20円）
        content = `
            <div class="form-group">
                <label class="form-label">戦略チップを選択（この期に使用）:</label>
                <select id="chipType" class="form-control" ${specificType ? 'disabled' : ''}>
                    <option value="research" ${specificType === 'research' ? 'selected' : ''}>研究 (¥20)</option>
                    <option value="education" ${specificType === 'education' ? 'selected' : ''}>教育 (¥20)</option>
                    <option value="advertising" ${specificType === 'advertising' ? 'selected' : ''}>広告 (¥20)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">購入数:</label>
                <select id="quantity" class="form-control">
                    <option value="1">1個</option>
                    <option value="2">2個</option>
                    <option value="3">3個</option>
                </select>
            </div>
        `;
    } else {
        // 3-5期：特急（40円）または繰り越し（20円）
        content = `
            <div class="form-group">
                <label class="form-label">戦略チップを選択:</label>
                <select id="chipType" class="form-control" ${specificType ? 'disabled' : ''}>
                    <option value="research" ${specificType === 'research' ? 'selected' : ''}>研究</option>
                    <option value="education" ${specificType === 'education' ? 'selected' : ''}>教育</option>
                    <option value="advertising" ${specificType === 'advertising' ? 'selected' : ''}>広告</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">購入タイプ:</label>
                <select id="purchaseType" class="form-control">
                    <option value="express">特急（¥40、即時使用）</option>
                    <option value="carryover">次期繰り越し（¥20、次期から使用）</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">購入数:</label>
                <select id="quantity" class="form-control">
                    <option value="1">1個</option>
                    <option value="2">2個</option>
                    <option value="3">3個</option>
                </select>
            </div>
        `;
    }
    
    content += '<button class="submit-btn" onclick="buyChips()">購入</button>';
    
    showModal('戦略チップ購入', content);
}

// Buy chips
function buyChips() {
    const company = gameState.companies[0];
    const chipType = document.getElementById('chipType').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    const period = gameState.currentPeriod;
    
    let cost = 0;
    let isExpress = false;
    
    if (period === 2) {
        // 2期：その期に使用（20円）
        cost = quantity * 20;
        isExpress = true;
    } else {
        // 3-5期：特急または繰り越し
        const purchaseType = document.getElementById('purchaseType').value;
        isExpress = purchaseType === 'express';
        cost = quantity * (isExpress ? 40 : 20);
    }
    
    if (company.cash < cost) {
        // 短期借入
        const needed = Math.ceil((cost - company.cash) / 0.6 / 50) * 50;
        company.shortLoans += needed;
        company.cash += needed * 0.6;
        alert(`現金不足のため短期借入¥${needed}を実行しました`);
    }
    
    // Check max limits
    const maxLimits = {research: 5, education: 1, advertising: 5};
    const currentTotal = company.chips[chipType] + company.nextPeriodChips[chipType] + quantity;
    if (currentTotal > maxLimits[chipType]) {
        alert(`${chipType}チップは最大${maxLimits[chipType]}個までです！`);
        return;
    }
    
    company.cash -= cost;
    
    if (isExpress) {
        // 即時使用
        company.chips[chipType] += quantity;
    } else {
        // 次期繰り越し
        company.nextPeriodChips[chipType] += quantity;
    }
    
    closeModal();
    updateDisplay();
    alert(`${chipType}チップを${quantity}個購入しました（¥${cost}）`);
    endTurn();
}

// Do nothing
function doNothing() {
    const company = gameState.companies[0];
    
    if (!gameState.doNothingCount[0]) {
        gameState.doNothingCount[0] = 0;
    }
    
    if (gameState.doNothingCount[0] >= 3) {
        alert('DO NOTHINGは連続3回までです！');
        return;
    }
    
    gameState.doNothingCount[0]++;
    alert(`DO NOTHINGを選択しました（${gameState.doNothingCount[0]}/3回）\n行は消費されません。`);
    
    // DO NOTHING doesn't use a row
    nextTurn();
}

// 行数を増やす関数（資源変更時に呼ぶ）
function incrementRow(companyIndex) {
    const company = gameState.companies[companyIndex];
    company.currentRow = (company.currentRow || 1) + 1;
    
    // ラスト5行の警告（最初に到達した会社のみ）
    if (!gameState.last5RowWarningShown && company.currentRow === gameState.maxRows - 4) {
        gameState.last5RowWarningShown = true;
        alert(`【警告】${company.name}がラスト5行に到達しました！\n残り${gameState.maxRows - company.currentRow + 1}行で期末です。`);
    }
    
    // 誰かが上限に達したら期末処理
    if (company.currentRow >= gameState.maxRows) {
        console.log(`${company.name}が行数上限（${gameState.maxRows}行）に達しました！期末処理を開始します。`);
        endPeriod();
        return true;  // 期末処理を開始した
    }
    return false;  // まだ続行
}

// End turn
function endTurn() {
    const company = gameState.companies[gameState.currentPlayerIndex];
    
    // 行数を増やす（資源変更があったため）
    if (incrementRow(gameState.currentPlayerIndex)) {
        return;  // 期末処理が始まったので終了
    }
    
    gameState.doNothingCount[gameState.currentPlayerIndex] = 0;
    
    nextTurn();
}

// Next turn
function nextTurn() {
    // Check skip turns
    const currentCompany = gameState.companies[gameState.currentPlayerIndex];
    if (currentCompany.skipTurns > 0) {
        currentCompany.skipTurns--;
        console.log(`${currentCompany.name}は休み（残り${currentCompany.skipTurns}回）`);
    }
    
    // ターン順の処理（逆回りの場合）
    if (gameState.turnReversed) {
        gameState.currentPlayerIndex--;
        if (gameState.currentPlayerIndex < 0) {
            gameState.currentPlayerIndex = gameState.companies.length - 1;
            gameState.currentRow++;
            
            if (gameState.currentRow > gameState.maxRows) {
                endPeriod();
                return;
            }
        }
    } else {
        gameState.currentPlayerIndex++;
        if (gameState.currentPlayerIndex >= gameState.companies.length) {
            gameState.currentPlayerIndex = 0;
            gameState.currentRow++;
            
            if (gameState.currentRow > gameState.maxRows) {
                endPeriod();
                return;
            }
        }
    }
    
    updateDisplay();
    
    // Auto-execute AI turn
    if (gameState.currentPlayerIndex !== 0) {
        setTimeout(executeAITurn, 1000);
    } else {
        // Player's turn
        if (gameState.companies[0].skipTurns > 0) {
            gameState.companies[0].skipTurns--;
            alert(`休み中（残り${gameState.companies[0].skipTurns}回）`);
            nextTurn();
        } else {
            showTurnStartOptions();
        }
    }
}

// Apply risk card to AI company
function applyRiskCardToAI(company, card) {
    let rowUsed = true;
    
    switch(card.id) {
        case 1: // クレーム発生
        case 2:
            company.cash = Math.max(0, company.cash - 5);
            break;
        case 3: // 教育成功
        case 4:
            if (company.chips.education > 0 && company.products > 0) {
                const sellQty = Math.min(getSalesCapacity(company), company.products, 5);
                company.cash += sellQty * 32;
                company.products -= sellQty;
                company.totalSales += sellQty * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
            }
            break;
        case 5: // 消費者運動発生
        case 6:
            // 販売禁止フラグを立てる
            company.cannotSell = true;
            alert('消費者運動発生！今期中販売禁止');
            // 強制的に材料購入、完成・投入、DoNothingの選択を表示
            showForcedActionModal();
            rowUsed = false;
            break;
        case 7: // 得意先倒産
        case 8:
            if (gameState.currentPeriod !== 2) {
                company.cash = Math.max(0, company.cash - 30);
            }
            break;
        case 9: // 研究開発失敗
        case 10:
        case 11:
            if (company.chips.research > 0) {
                company.chips.research--;
            }
            break;
        case 12: // 広告成功
        case 13:
        case 14:
            if (company.chips.advertising > 0 && company.products > 0) {
                const maxSell = Math.min(company.chips.advertising * 2, 5);
                const sellQty = Math.min(maxSell, company.products);
                company.cash += sellQty * 32;
                company.products -= sellQty;
                company.totalSales += sellQty * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
            }
            break;
        case 15: // 労災発生
        case 16:
            company.cannotProduce = true;
            break;
        case 17: // 広告政策失敗
        case 18:
            if (company.chips.advertising > 0) {
                company.chips.advertising--;
            }
            break;
        case 19: // 特別サービス
        case 20:
            // AIは材料購入を選択（5個まで1個10円）
            const buyQty = Math.min(5, Math.floor(company.cash / 10));
            if (buyQty > 0) {
                company.cash -= buyQty * 10;
                company.materials += buyQty;
            }
            break;
        case 21: // 返品発生
        case 22:
        case 23:
            if (gameState.currentPeriod !== 2) {
                company.totalSales -= 20;
                company.products++;
            }
            break;
        case 24: // 盗難発生
        case 25:
            if (company.chips.insurance > 0) {
                const stolen = Math.min(2, company.products);
                const compensation = stolen * 14;
                company.cash += compensation;
                company.products -= stolen;
                // 海外市場に移動
                const overseasMarket = gameState.markets.find(m => m.name === '海外');
                if (overseasMarket) {
                    overseasMarket.currentStock += stolen;
                }
                company.chips.insurance = 0;
            } else {
                const stolen = Math.min(2, company.products);
                company.products -= stolen;
                // 海外市場に移動
                const overseasMarket = gameState.markets.find(m => m.name === '海外');
                if (overseasMarket) {
                    overseasMarket.currentStock += stolen;
                }
            }
            break;
        case 26: // 新聞に掲載される
        case 27:
            // 空いた市場へ商品2個独占販売
            const sellQty2 = Math.min(2, company.products);
            if (sellQty2 > 0) {
                company.cash += sellQty2 * 32;
                company.products -= sellQty2;
                company.totalSales += sellQty2 * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty2;
            }
            break;
        case 28: // 災害募金
        case 29:
        case 30:
            company.cash = Math.max(0, company.cash - 10);
            break;
        case 31: // 倉庫火災
        case 32:
            if (company.chips.insurance > 0) {
                const compensation = company.materials * 8;
                company.cash += compensation;
                company.chips.insurance = 0;
            }
            company.materials = 0;
            break;
        case 33: // 縁故採用
        case 34:
            // 現金5円減少 + 固定費5円追加 + セールスマン1名追加（AI）
            company.cash = Math.max(0, company.cash - 5);
            company.specialLoss = (company.specialLoss || 0) + 5; // 固定費に5円追加
            company.salesmen++; // AIはセールスマンを追加
            break;
        case 43: // ストライキ発生
        case 44:
        case 59: // 社長病気
        case 60:
            company.skipTurns = 1;
            rowUsed = false;
            break;
        case 47: // 長期労務紛争
        case 48:
            company.skipTurns = 2;
            rowUsed = false;
            break;
        case 33: // 縁故採用
        case 34:
            // 現金5円減少 + 固定費5円追加 + ワーカーまたはセールスマン1名追加
            company.cash = Math.max(0, company.cash - 5);
            company.specialLoss = (company.specialLoss || 0) + 5; // 固定費に5円追加
            showHiringChoiceModal(); // ワーカーかセールスマンを選択
            rowUsed = false;
            break;
        case 35: // 研究開発成功
        case 36:
        case 37:
        case 38:
        case 39:
        case 40:
            if (company.chips.research > 0 && company.products > 0) {
                const salesCapacity = company.salesmen * 2 + company.chips.advertising + company.chips.education;
                const sellQty = Math.min(company.chips.research * 2, company.products, salesCapacity, 5);
                company.cash += sellQty * 32;
                company.products -= sellQty;
                company.totalSales += sellQty * 32;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
            }
            break;
        case 41: // 各社共通
        case 42:
            // 全社共通購入処理を実行
            executeAllCompaniesCommonPurchaseFromAI(company);
            return; // モーダル表示後に処理を中断
        case 45: // 訴訟発生
        case 46:
            company.cash = Math.max(0, company.cash - 10);
            break;
        case 49: // 情報漏洩
        case 50:
            company.cash = Math.max(0, company.cash - 20);
            break;
        case 51: // ワーカー退職
        case 52:
            company.cash = Math.max(0, company.cash - 5);
            if (company.workers > 0) {
                company.workers--;
            }
            break;
        case 53: // 景気変動（逆回り）
        case 54:
            gameState.turnReversed = !gameState.turnReversed;
            break;
        case 55: // 教育失敗
        case 56:
            if (company.chips.education > 0) {
                company.chips.education--;
            }
            break;
        case 57: // セールスマン退職
        case 58:
            company.cash = Math.max(0, company.cash - 5);
            if (company.salesmen > 0) {
                company.salesmen--;
            }
            break;
        case 61: // 不良在庫発生
        case 62:
            const totalInventory = company.materials + company.wip + company.products;
            if (totalInventory > 20) {
                const excess = totalInventory - 20;
                // 製品から優先的に除去
                const removeProducts = Math.min(excess, company.products);
                company.products -= removeProducts;
                if (company.chips.insurance > 0) {
                    company.cash += removeProducts * 10;
                }
            }
            break;
        case 63: // 機械故障
        case 64:
            company.cash = Math.max(0, company.cash - 5);
            // 機械故障による追加固定費を記録
            if (!company.additionalFixedCost) {
                company.additionalFixedCost = 0;
            }
            company.additionalFixedCost += 5;
            break;
        default:
            break;
    }
    
    if (rowUsed) {
        endTurn();
    } else {
        nextTurn();
    }
}

// Execute common purchase when AI draws the card
function executeAllCompaniesCommonPurchaseFromAI(aiCompany) {
    const playerCompany = gameState.companies[0];
    const content = `
        <div class="risk-display">
            <div class="risk-title">${aiCompany.name}が「各社共通」を引きました</div>
            <div class="risk-description">全社が12円で3個まで材料を購入できます<br>（まず市場から、不足分は海外から）</div>
        </div>
        <div style="margin-top: 20px;">
            <p>現在の現金: ¥${playerCompany.cash}</p>
            <div class="form-group">
                <label class="form-label">あなたの購入数量:</label>
                <select id="playerQuantity" class="form-control">
                    <option value="0">購入しない</option>
                    <option value="1">1個購入（¥12）</option>
                    <option value="2">2個購入（¥24）</option>
                    <option value="3">3個購入（¥36）</option>
                </select>
            </div>
            <button class="submit-btn" onclick="processAICommonPurchase()">決定</button>
        </div>
    `;
    
    showModal('各社共通購入', content);
    
    // AI会社を一時保存
    gameState.aiCommonPurchase = aiCompany;
}

// Process AI common purchase
function processAICommonPurchase() {
    const playerQty = parseInt(document.getElementById('playerQuantity').value || 0);
    const playerCompany = gameState.companies[0];
    const aiCompany = gameState.aiCommonPurchase;
    
    let purchaseLog = [];
    
    // プレイヤーの購入処理
    if (playerQty > 0) {
        const cost = playerQty * 12;
        if (playerCompany.cash >= cost) {
            let purchased = 0;
            
            // まず市場から購入
            for (const market of gameState.markets) {
                if (purchased >= playerQty) break;
                if (market.currentStock > 0) {
                    const qty = Math.min(playerQty - purchased, market.currentStock);
                    market.currentStock -= qty;
                    purchased += qty;
                }
            }
            
            // 不足分は海外市場（ストッカー）から
            const overseasMarket = gameState.markets.find(m => m.name === '海外');
            if (purchased < playerQty && overseasMarket) {
                const qty = playerQty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - qty);
                purchased += qty;
            }
            
            playerCompany.cash -= cost;
            playerCompany.materials += playerQty;
            playerCompany.totalMaterialCost += cost;
            playerCompany.rowsUsed++;
            
            purchaseLog.push(`あなた: ${playerQty}個購入（¥${cost}）`);
        } else {
            purchaseLog.push('あなた: 現金不足で購入できず');
        }
    } else {
        purchaseLog.push('あなた: 購入しない');
    }
    
    // 全AI会社の購入処理
    for (let i = 1; i < gameState.companies.length; i++) {
        const company = gameState.companies[i];
        const maxQty = Math.min(3, Math.floor(company.cash / 12));
        
        if (maxQty > 0 && Math.random() < 0.7) { // 70%の確率で購入
            const qty = Math.floor(Math.random() * maxQty) + 1; // 1～最大個数
            const cost = qty * 12;
            
            let purchased = 0;
            
            // まず市場から購入
            for (const market of gameState.markets) {
                if (purchased >= qty) break;
                if (market.currentStock > 0) {
                    const buyQty = Math.min(qty - purchased, market.currentStock);
                    market.currentStock -= buyQty;
                    purchased += buyQty;
                }
            }
            
            // 不足分は海外市場から
            const overseasMarket = gameState.markets.find(m => m.name === '海外');
            if (purchased < qty && overseasMarket) {
                const buyQty = qty - purchased;
                overseasMarket.currentStock = Math.max(0, overseasMarket.currentStock - buyQty);
                purchased += qty;
            }
            
            company.cash -= cost;
            company.materials += qty;
            company.totalMaterialCost += cost;
            
            purchaseLog.push(`${company.name}: ${qty}個購入（¥${cost}）`);
        } else {
            purchaseLog.push(`${company.name}: 購入しない`);
        }
    }
    
    closeModal();
    updateDisplay();
    
    // 購入結果を表示
    alert('【各社共通購入結果】\n' + purchaseLog.join('\n'));
    
    // AIのターンを終了
    gameState.aiCommonPurchase = null;
    nextTurn();
}

// Execute AI turn  
function executeAITurn() {
    const company = gameState.companies[gameState.currentPlayerIndex];
    
    if (company.skipTurns > 0) {
        company.skipTurns--;
        nextTurn();
        return;
    }
    
    // リスクカード確率（性格により変動）
    let riskChance = 0.2;
    if (company.strategy === 'aggressive') riskChance = 0.25;  // A社：リスク高め
    if (company.strategy === 'conservative') riskChance = 0.15; // C社：リスク低め
    
    if (Math.random() < riskChance) {
        const availableCards = gameState.riskCards.filter(card => {
            if (gameState.currentPeriod === 2 && card.period2Exempt) return false;
            return !gameState.usedRiskCards.includes(card.id);
        });
        
        if (availableCards.length > 0) {
            const card = availableCards[Math.floor(Math.random() * availableCards.length)];
            gameState.usedRiskCards.push(card.id);
            console.log(`${company.name}がリスクカード「${card.name}」を引きました`);
            
            // Apply risk card effect to AI
            applyRiskCardToAI(company, card);
            
            // リスクカードを引いたことを通知
            alert(`${company.name}がリスクカード「${card.name}」を引きました\n${card.description}`);
            return; // リスクカードを引いたらターン終了
        }
    }
    
    // 緊急採用チェック（ワーカーまたはセールスマンが0人）
    if (company.workers === 0 || company.salesmen === 0) {
        // 緊急採用を実行
        let hireWorkers = 0;
        let hireSalesmen = 0;
        
        if (company.workers === 0) {
            hireWorkers = 1; // 最低1人採用
        }
        if (company.salesmen === 0) {
            hireSalesmen = 1; // 最低1人採用
        }
        
        const cost = (hireWorkers + hireSalesmen) * 5;
        if (company.cash >= cost) {
            company.cash -= cost;
            company.workers += hireWorkers;
            company.salesmen += hireSalesmen;
            incrementRow(gameState.companies.indexOf(company));
            
            let message = `${company.name}が緊急採用を実施！\n`;
            if (hireWorkers > 0) message += `ワーカー${hireWorkers}人 `;
            if (hireSalesmen > 0) message += `セールスマン${hireSalesmen}人`;
            message += `\n費用: ¥${cost}`;
            alert(message);
            
            nextTurn();
            return;
        } else {
            // 現金不足の場合は短期借入
            const needed = Math.ceil((cost - company.cash) / 0.6 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.6;
            company.cash -= cost;
            company.workers += hireWorkers;
            company.salesmen += hireSalesmen;
            incrementRow(gameState.companies.indexOf(company));
            
            let message = `${company.name}が緊急採用を実施！\n`;
            if (hireWorkers > 0) message += `ワーカー${hireWorkers}人 `;
            if (hireSalesmen > 0) message += `セールスマン${hireSalesmen}人`;
            message += `\n短期借入¥${needed}で資金調達\n費用: ¥${cost}`;
            alert(message);
            
            nextTurn();
            return;
        }
    }
    
    // AI性格別戦略実行
    const mfgCapacity = getManufacturingCapacity(company);
    const salesCapacity = getSalesCapacity(company);
    
    executeAIStrategyByType(company, mfgCapacity, salesCapacity);
}

// AI性格別の戦略実行
function executeAIStrategyByType(company, mfgCapacity, salesCapacity) {
    switch(company.strategy) {
        case 'aggressive':    // A社：積極的
            executeAggressiveStrategy(company, mfgCapacity, salesCapacity);
            break;
        case 'conservative':  // C社：保守的  
            executeConservativeStrategy(company, mfgCapacity, salesCapacity);
            break;
        case 'price_focused': // D社：価格競争
            executePriceFocusedStrategy(company, mfgCapacity, salesCapacity);
            break;
        case 'tech_focused':  // E社：技術重視
            executeTechFocusedStrategy(company, mfgCapacity, salesCapacity);
            break;
        default:             // B社：バランス
            executeBalancedStrategy(company, mfgCapacity, salesCapacity);
    }
}

// A社：積極的戦略（MQ最大化重視）
function executeAggressiveStrategy(company, mfgCapacity, salesCapacity) {
    // MQを最大化するための戦略的判断
    
    // 1. 販売優先（PQを増やす）
    if (company.products > 0 && salesCapacity > 0) {
        const sellQty = Math.min(company.products, salesCapacity);
        // 高価格市場を優先
        const bestMarket = gameState.markets
            .filter(m => m.currentStock < m.maxStock && (gameState.currentPeriod > 2 || m.name !== '海外'))
            .sort((a, b) => b.sellPrice - a.sellPrice)[0];
        
        if (bestMarket && sellQty > 0) {
            executeDefaultSale(company, salesCapacity, 0.75);
            return;
        }
    }
    
    // 2. 生産最大化（在庫を製品に変換）
    if (company.materials > 0 && mfgCapacity > 0) {
        const produceQty = Math.min(company.materials, mfgCapacity);
        if (produceQty > 0) {
            executeDefaultProduction(company, mfgCapacity);
            return;
        }
    }
    
    // 3. 材料購入（低価格で購入）
    if (company.cash > 40 && company.materials < 5) {
        executeDefaultMaterialPurchase(company, Math.min(5, mfgCapacity));
        return;
    }
    
    // 4. 能力向上投資（MQ最大化のため積極的に投資）
    if (company.cash > 60 && company.currentRow < gameState.maxRows - 5) {
        // 研究チップ優先（価格競争力とMQ向上）
        if (company.chips.research < 5 && Math.random() > 0.3) {
            const cost = gameState.currentPeriod === 2 ? 20 : 40;
            if (company.cash >= cost) {
                company.cash -= cost;
                company.chips.research++;
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
        // 広告チップ（販売能力向上）
        if (company.chips.advertising < 4 && Math.random() > 0.4) {
            const cost = gameState.currentPeriod === 2 ? 20 : 40;
            if (company.cash >= cost) {
                company.cash -= cost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
        // 教育チップ（製造・販売能力向上）
        if (company.chips.education < 3 && Math.random() > 0.5) {
            const cost = gameState.currentPeriod === 2 ? 20 : 40;
            if (company.cash >= cost) {
                company.cash -= cost;
                company.chips.education++;
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
        // 機械投資
        if (company.machines.length < 3 && company.cash > 100) {
            company.cash -= 50;
            company.machines.push({type: 'small', attachments: 0});
            incrementRow(gameState.companies.indexOf(company));
            nextTurn();
            return;
        }
    }
    
    // 販売最優先
    if (company.products >= salesCapacity && salesCapacity > 0) {
        // Find best market (high price, has space)
        const availableMarkets = gameState.markets.filter(m => 
            m.currentStock < m.maxStock && 
            (gameState.currentPeriod > 2 || m.name !== '海外')
        ).sort((a, b) => b.sellPrice - a.sellPrice);
        
        if (availableMarkets.length > 0) {
            const market = availableMarkets[0];
            const sellQty = Math.min(salesCapacity, company.products, market.maxStock - market.currentStock);
            
            if (market.needsBid) {
                // Check if player wants to participate
                const playerCompany = gameState.companies[0];
                
                if (playerCompany.products > 0) {
                    // Store AI company's bid info and ask player
                    gameState.aiPendingBid = {
                        company: gameState.currentPlayerIndex,
                        market: market,
                        marketIndex: gameState.markets.indexOf(market),
                        price: Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25)) - getPriceCompetitiveness(company),
                        quantity: sellQty
                    };
                    
                    // Show modal to ask player if they want to bid
                    showAIBidNotification();
                    return; // Exit here, will continue after player decides
                }
                
                // Process bidding with all companies (player has no products)
                const allBids = [];
                
                // 価格設定（性格により変動）
                let priceMultiplier = 0.7 + Math.random() * 0.25;
                if (company.strategy === 'price_focused') {
                    priceMultiplier = 0.6 + Math.random() * 0.2;  // D社：より低価格
                } else if (company.strategy === 'conservative') {
                    priceMultiplier = 0.75 + Math.random() * 0.2; // C社：安定価格
                } else if (company.strategy === 'aggressive') {
                    priceMultiplier = 0.65 + Math.random() * 0.25; // A社：積極的価格
                }
                
                // Current AI company's bid
                const bidPrice = Math.floor(market.sellPrice * priceMultiplier) - getPriceCompetitiveness(company);
                const displayPrice = Math.floor(market.sellPrice * priceMultiplier);
                allBids.push({company: gameState.currentPlayerIndex, price: bidPrice, quantity: sellQty, displayPrice: displayPrice});
                
                // All other companies (including player) also bid if they have products
                for (let i = 0; i < gameState.companies.length; i++) {
                    if (i !== gameState.currentPlayerIndex) {
                        const otherCompany = gameState.companies[i];
                        if (otherCompany.products > 0) {
                            const otherCapacity = getSalesCapacity(otherCompany);
                            const otherQty = Math.min(otherCapacity, otherCompany.products, market.maxStock - market.currentStock);
                            if (otherQty > 0) {
                                let otherPrice;
                                if (i === 0) {
                                    // Player company - use strategic pricing
                                    otherPrice = Math.floor(market.sellPrice * 0.85) - getPriceCompetitiveness(otherCompany);
                                } else {
                                    // AI company
                                    otherPrice = Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25)) - getPriceCompetitiveness(otherCompany);
                                }
                                const otherDisplayPrice = i === 0 ? Math.floor(market.sellPrice * 0.85) : Math.floor(market.sellPrice * (0.7 + Math.random() * 0.25));
                                allBids.push({company: i, price: otherPrice, quantity: otherQty, displayPrice: otherDisplayPrice});
                            }
                        }
                    }
                }
                
                // Sort by price (lowest wins)
                allBids.sort((a, b) => a.price - b.price);
                
                // Process winner's sale
                const winner = allBids[0];
                const winCompany = gameState.companies[winner.company];
                const actualQty = Math.min(winner.quantity, market.maxStock - market.currentStock);
                
                if (actualQty > 0) {
                    const salePrice = winner.displayPrice || winner.price;
                    winCompany.cash += salePrice * actualQty;
                    winCompany.products -= actualQty;
                    winCompany.totalSales += salePrice * actualQty;
                    winCompany.totalSoldQuantity = (winCompany.totalSoldQuantity || 0) + actualQty;
                    market.currentStock += actualQty;
                    
                    // Notify player if they participated
                    if (winner.company === 0) {
                        console.log(`プレイヤーが${market.name}に¥${winner.price}×${actualQty}個で落札しました！`);
                    } else if (gameState.companies[0].products > 0) {
                        console.log(`${winCompany.name}が${market.name}に¥${winner.price}×${actualQty}個で落札（プレイヤーも参加）`);
                    } else {
                        console.log(`入札結果: ${winCompany.name}が${market.name}に¥${winner.price}×${actualQty}個で落札`);
                    }
                }
            } else {
                // Direct sale (no bidding)
                company.cash += market.sellPrice * sellQty;
                company.products -= sellQty;
                company.totalSales += market.sellPrice * sellQty;
                company.totalSoldQuantity = (company.totalSoldQuantity || 0) + sellQty;
                market.currentStock += sellQty;
            }
            
            incrementRow(gameState.companies.indexOf(company));
            nextTurn();
            return;
        }
    }
    
    // Buy materials if low
    if (company.materials < 3 && company.cash > 50) {
        // Find cheapest market with stock
        const availableMarkets = gameState.markets.filter(m => m.currentStock > 0)
            .sort((a, b) => a.buyPrice - b.buyPrice);
        
        if (availableMarkets.length > 0) {
            const market = availableMarkets[0];
            const buyQty = Math.min(3, market.currentStock, Math.floor(company.cash / market.buyPrice));
            
            if (buyQty > 0) {
                company.cash -= market.buyPrice * buyQty;
                company.materials += buyQty;
                company.totalMaterialCost += market.buyPrice * buyQty;
                market.currentStock -= buyQty;
                
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
    }
    
    // Produce if has materials
    if (company.materials > 0 && company.cash > mfgCapacity) {
        const produceQty = Math.min(mfgCapacity, company.materials);
        const wipToProduct = Math.min(mfgCapacity, company.wip);
        const cost = produceQty + wipToProduct;
        
        if (company.cash >= cost) {
            company.cash -= cost;
            company.materials -= produceQty;
            company.wip += produceQty - wipToProduct;
            company.products += wipToProduct;
            company.totalProductionCost += cost;
            
            incrementRow(gameState.companies.indexOf(company));
            nextTurn();
            return;
        }
    }
    
    // 投資戦略（性格により異なる）
    executeDefaultInvestment(company);
}

// C社：保守的戦略（安定的MQ確保）
function executeConservativeStrategy(company, mfgCapacity, salesCapacity) {
    // 安定的にMQを確保する戦略
    
    // 1. 確実な販売（在庫リスク回避）
    if (company.products >= 2 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.8);
        return;
    }
    
    // 2. 安定生産
    if (company.materials >= 2 && mfgCapacity > 0 && company.products < 3) {
        executeDefaultProduction(company, Math.min(2, mfgCapacity));
        return;
    }
    
    // 3. 計画的材料購入
    if (company.cash > 60 && company.materials < 3) {
        // 低価格市場を優先
        const cheapMarket = gameState.markets
            .filter(m => m.currentStock > 0)
            .sort((a, b) => a.buyPrice - b.buyPrice)[0];
        
        if (cheapMarket) {
            executeDefaultMaterialPurchase(company, 3);
            return;
        }
    }
    
    // 4. コスト削減投資（コンピュータチップ）
    if (company.cash > 100 && company.chips.computer === 0) {
        company.cash -= 20;
        company.chips.computer = 1;
        incrementRow(gameState.companies.indexOf(company));
        nextTurn();
        return;
    }
    
    // 慎重に生産
    if (company.materials > 0 && company.cash > 50) {
        executeDefaultProduction(company, Math.min(mfgCapacity, 2));
        return;
    }
    
    // Do Nothing（行数を増やさない）
    nextTurn();
}

// D社：価格競争戦略（量でMQ確保）
function executePriceFocusedStrategy(company, mfgCapacity, salesCapacity) {
    // 大量生産・大量販売でMQを確保
    
    // 1. 大量販売（低価格でも量で勝負）
    if (company.products >= 3 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.65);
        return;
    }
    
    // 2. 大量生産
    if (company.materials >= 3 && mfgCapacity >= 3) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }
    
    // 3. 大量材料購入（安い市場から）
    if (company.cash > 60 && company.materials < 6) {
        // 最安市場を選択
        const cheapestMarket = gameState.markets
            .filter(m => m.currentStock > 0)
            .sort((a, b) => a.buyPrice - b.buyPrice)[0];
        
        if (cheapestMarket) {
            const buyQty = Math.min(6, Math.floor(company.cash / cheapestMarket.buyPrice));
            executeDefaultMaterialPurchase(company, buyQty);
            return;
        }
    }
    
    // 4. 生産能力向上
    if (company.cash > 120 && company.workers < 3) {
        // ワーカー採用
        company.workers++;
        incrementRow(gameState.companies.indexOf(company));
        nextTurn();
        return;
    }
    
    // 何もしなかった場合はDo Nothing
    nextTurn();
}

// E社：技術重視戦略（能力向上でMQ最大化）
function executeTechFocusedStrategy(company, mfgCapacity, salesCapacity) {
    // 技術投資で効率を上げてMQを最大化
    
    // 1. 高効率販売
    if (company.products > 0 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.8);
        return;
    }
    
    // 2. 効率的生産
    if (company.materials > 0 && mfgCapacity > 0) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }
    
    // 3. 技術投資優先（積極的にチップ購入）
    if (company.cash > 50 && company.currentRow < gameState.maxRows - 5) {
        // 研究チップ（価格競争力）
        if (company.chips.research < 6 && Math.random() > 0.2) {
            const cost = gameState.currentPeriod === 2 ? 20 : 40;
            if (company.cash >= cost) {
                company.cash -= cost;
                company.chips.research++;
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
        
        // 教育チップ（製造・販売能力+1）
        if (company.chips.education < 4 && Math.random() > 0.3) {
            const cost = gameState.currentPeriod === 2 ? 20 : 40;
            if (company.cash >= cost) {
                company.cash -= cost;
                company.chips.education++;
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
        
        // 広告チップ（販売能力）
        if (company.chips.advertising < 5 && Math.random() > 0.4) {
            const cost = gameState.currentPeriod === 2 ? 20 : 40;
            if (company.cash >= cost) {
                company.cash -= cost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
        
        // 機械投資
        if (company.machines.length < 4 && company.cash > 80) {
            company.cash -= 50;
            company.machines.push({type: 'small', attachments: 0});
            incrementRow(gameState.companies.indexOf(company));
            nextTurn();
            return;
        }
    }
    
    // 4. 材料購入
    if (company.cash > 40 && company.materials < 3) {
        executeDefaultMaterialPurchase(company, 3);
        return;
    }
    
    // 通常の販売・生産
    executeBalancedStrategy(company, mfgCapacity, salesCapacity);
}

// B社・デフォルト：バランス戦略（MQバランス）
function executeBalancedStrategy(company, mfgCapacity, salesCapacity) {
    // バランス良くMQを増やす
    
    // 1. 販売機会を逃さない
    if (company.products >= 2 && salesCapacity > 0) {
        executeDefaultSale(company, salesCapacity, 0.75);
        return;
    }
    
    // 2. 効率的生産
    if (company.materials >= 2 && mfgCapacity >= 2 && company.products < 4) {
        executeDefaultProduction(company, mfgCapacity);
        return;
    }
    
    // 3. 材料確保
    if (company.cash > 50 && company.materials < 4) {
        executeDefaultMaterialPurchase(company, Math.min(4, mfgCapacity));
        return;
    }
    
    // 4. 戦略的投資
    if (company.cash > 80 && gameState.currentRow < gameState.maxRows - 8) {
        // 広告チップ（販売力強化）
        if (company.chips.advertising < 2 && company.salesmen > 0) {
            const cost = gameState.currentPeriod === 2 ? 20 : 40;
            if (company.cash >= cost) {
                company.cash -= cost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
    }
    
    executeDefaultInvestment(company);
}

// 共通関数：販売実行
function executeDefaultSale(company, salesCapacity, priceBase) {
    const sellQty = Math.min(salesCapacity, company.products);
    if (sellQty <= 0) {
        incrementRow(gameState.companies.indexOf(company));
        nextTurn();
        return;
    }
    
    // 適切な市場を選択（既存のロジックを活用）
    // ここは既存の販売ロジックに委譲
    incrementRow(gameState.companies.indexOf(company));
    nextTurn();
}

// 共通関数：材料購入
function executeDefaultMaterialPurchase(company, targetQty) {
    const availableMarkets = gameState.markets.filter(m => m.currentStock > 0)
        .sort((a, b) => a.buyPrice - b.buyPrice);
    
    if (availableMarkets.length > 0) {
        const market = availableMarkets[0];
        const buyQty = Math.min(targetQty, market.currentStock, Math.floor(company.cash / market.buyPrice));
        
        if (buyQty > 0) {
            company.cash -= market.buyPrice * buyQty;
            company.materials += buyQty;
            company.totalMaterialCost += market.buyPrice * buyQty;
            market.currentStock -= buyQty;
        }
    }
    
    incrementRow(gameState.companies.indexOf(company));
    nextTurn();
}

// 共通関数：生産実行
function executeDefaultProduction(company, maxQty) {
    const produceQty = Math.min(maxQty, company.materials);
    const wipToProduct = Math.min(maxQty, company.wip);
    const cost = produceQty + wipToProduct;
    
    if (company.cash >= cost && produceQty > 0) {
        company.cash -= cost;
        company.materials -= produceQty;
        company.wip += produceQty - wipToProduct;
        company.products += wipToProduct;
        company.totalProductionCost += cost;
    }
    
    incrementRow(gameState.companies.indexOf(company));
    nextTurn();
}

// 共通関数：投資実行
function executeDefaultInvestment(company) {
    // 投資確率（性格により変動）
    let investChance = 0.3;
    if (company.strategy === 'tech_focused') investChance = 0.5;
    if (company.strategy === 'aggressive') investChance = 0.4;
    if (company.strategy === 'conservative') investChance = 0.2;
    
    if (Math.random() < investChance && company.cash > 50) {
        const rand = Math.random();
        const chipCost = gameState.currentPeriod === 2 ? 20 : 40;
        
        // 戦略チップ購入（50%の確率）
        if (rand < 0.5 && company.cash >= chipCost) {
            const chipRand = Math.random();
            if (chipRand < 0.35 && company.chips.research < 4) {
                company.cash -= chipCost;
                company.chips.research++;
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            } else if (chipRand < 0.7 && company.chips.advertising < 3) {
                company.cash -= chipCost;
                company.chips.advertising++;
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            } else if (company.chips.education < 2) {
                company.cash -= chipCost;
                company.chips.education++;
                incrementRow(gameState.companies.indexOf(company));
                nextTurn();
                return;
            }
        }
        // 人員採用（25%の確率）
        else if (rand < 0.75 && company.workers < 3 && company.cash >= 5) {
            company.cash -= 5;
            company.workers++;
            incrementRow(gameState.companies.indexOf(company));
            nextTurn();
            return;
        } 
        // セールスマン採用（25%の確率）
        else if (company.salesmen < 3 && company.cash >= 5) {
            company.cash -= 5;
            company.salesmen++;
            incrementRow(gameState.companies.indexOf(company));
            nextTurn();
            return;
        }
    }
    
    // 何もしなかった場合はDo Nothing
    nextTurn();
}

// End period
function endPeriod() {
    alert('期末決算を開始します');
    
    // 期末時点の人数・機械台数を記録
    gameState.companies.forEach(company => {
        company.endOfPeriodStats = {
            workers: company.workers,
            salesmen: company.salesmen,
            machines: company.machines.length
        };
    });
    
    // Calculate financial metrics for all companies
    const financialData = [];
    
    gameState.companies.forEach(company => {
        // Calculate PQ, VQ, MQ, G
        const pq = company.totalSales;
        const vq = calculateVQ(company);
        const mq = pq - vq;
        const fixedCosts = calculateFixedCost(company);
        const g = mq - fixedCosts - (company.specialLoss || 0);
        
        // Q = 販売個数（期中の総販売数量）
        const q = company.totalSoldQuantity || 0;
        
        // 期末在庫数（V/M計算用）
        const totalEndInventory = (company.materials || 0) + (company.wip || 0) + (company.products || 0);
        
        // Calculate unit prices (P=PQ/Q, V=VQ/期末在庫数, M=MQ/期末在庫数) with rounding to 1 decimal place
        const unitP = q > 0 ? Math.round(pq / q * 10) / 10 : 0;  // Pは販売数Qで割る
        const unitV = totalEndInventory > 0 ? Math.round(vq / totalEndInventory * 10) / 10 : 0;  // Vは期末在庫数で割る
        const unitM = totalEndInventory > 0 ? Math.round(mq / totalEndInventory * 10) / 10 : 0;  // Mは期末在庫数で割る
        
        financialData.push({
            name: company.name,
            p: unitP,  // P=PQ/Q (単価)
            v: unitV,  // V=VQ/Q (単価)
            m: unitM,  // M=MQ/Q (単価)
            q: q,
            pq: pq,
            vq: vq,
            mq: mq,
            f: fixedCosts,
            g: g
        });
        
        // Update equity
        company.equity += g;
        
        // Pay period-end costs (using end-of-period stats)
        const periodPayment = calculatePeriodPayment(company, true);
        company.cash -= periodPayment;
        
        // Apply short-term loan if cash is negative
        if (company.cash < 0) {
            const needed = Math.ceil(Math.abs(company.cash) / 0.6 / 50) * 50;
            company.shortLoans += needed;
            company.cash += needed * 0.6;
        }
        
        // Handle chip returns
        if (gameState.currentPeriod === 2) {
            // 2期末：コンピュータ・保険は返却、研究・広告は最大3枚まで持ち越し
            const maxCarryOver = 3;
            const totalResearch = company.chips.research + company.nextPeriodChips.research;
            const totalAdvertising = company.chips.advertising + company.nextPeriodChips.advertising;
            const totalEducation = company.chips.education + company.nextPeriodChips.education;
            
            // 3枚を超える場合は警告
            if (totalResearch > maxCarryOver && company.type === 'player') {
                alert(`研究チップが${totalResearch}枚ありますが、3枚までしか持ち越せません。`);
            }
            if (totalAdvertising > maxCarryOver && company.type === 'player') {
                alert(`広告チップが${totalAdvertising}枚ありますが、3枚までしか持ち越せません。`);
            }
            
            // 次期チップ設定
            company.chips.computer = 0;  // 返却
            company.chips.insurance = 0; // 返却
            company.chips.research = Math.min(totalResearch, maxCarryOver);
            company.chips.education = Math.max(0, totalEducation - 1); // 1枚減
            company.chips.advertising = Math.max(0, Math.min(totalAdvertising, maxCarryOver) - 1); // 3枚制限後、1枚減
            company.nextPeriodChips = {research: 0, education: 0, advertising: 0};
        } else {
            // 3-5期末：全チップ没収（繰越分は残る）
            company.chips = {
                computer: 0,
                insurance: 0,
                research: company.nextPeriodChips.research,
                education: company.nextPeriodChips.education,
                advertising: company.nextPeriodChips.advertising
            };
            company.nextPeriodChips = {research: 0, education: 0, advertising: 0};
        }
        
        // Update period start inventory
        company.periodStartInventory = {
            materials: company.materials,
            wip: company.wip,
            products: company.products
        };
        
        // Reset period tracking
        company.rowsUsed = 0;
        company.totalSales = 0;
        company.totalSoldQuantity = 0;
        company.totalMaterialCost = 0;
        company.totalProductionCost = 0;
        company.specialLoss = 0;
    });
    
    // Store and show financial summary
    window.lastFinancialData = financialData;
    showFinancialSummary(financialData);
}

// End game
function endGame() {
    const rankings = [...gameState.companies].sort((a, b) => b.equity - a.equity);
    
    let resultHtml = '<div class="breakdown-list">';
    rankings.forEach((company, index) => {
        resultHtml += `
            <div class="breakdown-item">
                <span>${index + 1}位: ${company.name}</span>
                <span>自己資本: ¥${company.equity}</span>
            </div>
        `;
    });
    resultHtml += '</div>';
    
    showModal('ゲーム終了 - 最終結果', resultHtml);
}

// Initialize game
function initGame() {
    console.log("initGame started");
    try {
        initializeCompanies();
        console.log("Companies initialized");
        updateDisplay();
        console.log("Display updated");
    } catch(e) {
        console.error("Error in initGame:", e);
        alert("エラーが発生しました: " + e.message);
    }
}

// Start the game
console.log("Starting game...");
initGame();
    </script>
</body>
</html>